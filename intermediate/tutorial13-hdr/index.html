<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>하이 다이내믹 레인지 렌더링 (High Dynamic Range Rendering) | Learn Wgpu</title>
    <meta name="generator" content="VuePress 1.9.10">
    
    <meta name="description" content="">
    
    <link rel="preload" href="/learn-wgpu/assets/css/0.styles.81cb5453.css" as="style"><link rel="preload" href="/learn-wgpu/assets/js/app.796ffba2.js" as="script"><link rel="preload" href="/learn-wgpu/assets/js/3.d666109b.js" as="script"><link rel="preload" href="/learn-wgpu/assets/js/2.3bb15672.js" as="script"><link rel="preload" href="/learn-wgpu/assets/js/14.1b3a90b7.js" as="script"><link rel="preload" href="/learn-wgpu/assets/js/20.178554f0.js" as="script"><link rel="preload" href="/learn-wgpu/assets/js/37.a2b9f953.js" as="script"><link rel="prefetch" href="/learn-wgpu/assets/js/1.187b396e.js"><link rel="prefetch" href="/learn-wgpu/assets/js/10.a432dd1d.js"><link rel="prefetch" href="/learn-wgpu/assets/js/11.3ec612b9.js"><link rel="prefetch" href="/learn-wgpu/assets/js/12.e324cc11.js"><link rel="prefetch" href="/learn-wgpu/assets/js/13.04ed804c.js"><link rel="prefetch" href="/learn-wgpu/assets/js/15.623030e6.js"><link rel="prefetch" href="/learn-wgpu/assets/js/16.4611bcb5.js"><link rel="prefetch" href="/learn-wgpu/assets/js/17.709767f5.js"><link rel="prefetch" href="/learn-wgpu/assets/js/18.938c6bd0.js"><link rel="prefetch" href="/learn-wgpu/assets/js/19.fad5e54d.js"><link rel="prefetch" href="/learn-wgpu/assets/js/21.9e299fcc.js"><link rel="prefetch" href="/learn-wgpu/assets/js/22.c7ead717.js"><link rel="prefetch" href="/learn-wgpu/assets/js/23.9d0a23fc.js"><link rel="prefetch" href="/learn-wgpu/assets/js/24.fc889c2f.js"><link rel="prefetch" href="/learn-wgpu/assets/js/25.941e3dd6.js"><link rel="prefetch" href="/learn-wgpu/assets/js/26.f270b4cd.js"><link rel="prefetch" href="/learn-wgpu/assets/js/27.858fd637.js"><link rel="prefetch" href="/learn-wgpu/assets/js/28.0f431dfe.js"><link rel="prefetch" href="/learn-wgpu/assets/js/29.098da917.js"><link rel="prefetch" href="/learn-wgpu/assets/js/30.379eac67.js"><link rel="prefetch" href="/learn-wgpu/assets/js/31.3b679374.js"><link rel="prefetch" href="/learn-wgpu/assets/js/32.f42ff376.js"><link rel="prefetch" href="/learn-wgpu/assets/js/33.ac5b507a.js"><link rel="prefetch" href="/learn-wgpu/assets/js/34.50a4fad6.js"><link rel="prefetch" href="/learn-wgpu/assets/js/35.be37c498.js"><link rel="prefetch" href="/learn-wgpu/assets/js/36.f68470b2.js"><link rel="prefetch" href="/learn-wgpu/assets/js/38.10571145.js"><link rel="prefetch" href="/learn-wgpu/assets/js/39.91625f3e.js"><link rel="prefetch" href="/learn-wgpu/assets/js/4.67c56359.js"><link rel="prefetch" href="/learn-wgpu/assets/js/40.7624e351.js"><link rel="prefetch" href="/learn-wgpu/assets/js/41.64fc17ac.js"><link rel="prefetch" href="/learn-wgpu/assets/js/42.94b3689b.js"><link rel="prefetch" href="/learn-wgpu/assets/js/43.d9e52ef4.js"><link rel="prefetch" href="/learn-wgpu/assets/js/44.6f8c417d.js"><link rel="prefetch" href="/learn-wgpu/assets/js/45.548c112a.js"><link rel="prefetch" href="/learn-wgpu/assets/js/46.038ca8e5.js"><link rel="prefetch" href="/learn-wgpu/assets/js/47.05a5e491.js"><link rel="prefetch" href="/learn-wgpu/assets/js/48.8b993979.js"><link rel="prefetch" href="/learn-wgpu/assets/js/49.a105f8a6.js"><link rel="prefetch" href="/learn-wgpu/assets/js/5.c397ffe5.js"><link rel="prefetch" href="/learn-wgpu/assets/js/50.455d3855.js"><link rel="prefetch" href="/learn-wgpu/assets/js/51.b72dcfb2.js"><link rel="prefetch" href="/learn-wgpu/assets/js/52.657fe2a7.js"><link rel="prefetch" href="/learn-wgpu/assets/js/53.cd02a60a.js"><link rel="prefetch" href="/learn-wgpu/assets/js/54.26e3ff32.js"><link rel="prefetch" href="/learn-wgpu/assets/js/55.7997dcfe.js"><link rel="prefetch" href="/learn-wgpu/assets/js/56.a47b4481.js"><link rel="prefetch" href="/learn-wgpu/assets/js/57.c0170dc5.js"><link rel="prefetch" href="/learn-wgpu/assets/js/58.5b1cd8dd.js"><link rel="prefetch" href="/learn-wgpu/assets/js/59.13d91b4c.js"><link rel="prefetch" href="/learn-wgpu/assets/js/6.0dfb00be.js"><link rel="prefetch" href="/learn-wgpu/assets/js/60.718010a4.js"><link rel="prefetch" href="/learn-wgpu/assets/js/61.4c5bf94a.js"><link rel="prefetch" href="/learn-wgpu/assets/js/62.e415c60b.js"><link rel="prefetch" href="/learn-wgpu/assets/js/63.77367ef6.js"><link rel="prefetch" href="/learn-wgpu/assets/js/64.eb8b208f.js"><link rel="prefetch" href="/learn-wgpu/assets/js/65.fa399594.js"><link rel="prefetch" href="/learn-wgpu/assets/js/66.4d713c1a.js"><link rel="prefetch" href="/learn-wgpu/assets/js/67.3dcd188e.js"><link rel="prefetch" href="/learn-wgpu/assets/js/68.bbf40869.js"><link rel="prefetch" href="/learn-wgpu/assets/js/69.cf58d7ac.js"><link rel="prefetch" href="/learn-wgpu/assets/js/70.e84f83b3.js"><link rel="prefetch" href="/learn-wgpu/assets/js/71.3e200253.js"><link rel="prefetch" href="/learn-wgpu/assets/js/72.e40b9171.js"><link rel="prefetch" href="/learn-wgpu/assets/js/9.a241c78d.js"><link rel="prefetch" href="/learn-wgpu/assets/js/vendors~docsearch.d7f0baa9.js">
    <link rel="stylesheet" href="/learn-wgpu/assets/css/0.styles.81cb5453.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="inner"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/learn-wgpu/" class="home-link router-link-active"><!----> <span class="site-name">Learn Wgpu</span></a> <div class="links"><!----> <div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div></div></div></header> <div class="sidebar-mask"></div> <div class="docs-layout"><aside class="sidebar"><!---->  <ul class="sidebar-links"><li><a href="/learn-wgpu/" aria-current="page" class="sidebar-link">소개</a></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Beginner</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/learn-wgpu/beginner/tutorial1-window/" class="sidebar-link">의존성과 윈도우</a></li><li><a href="/learn-wgpu/beginner/tutorial2-surface/" class="sidebar-link">표면(The Surface)</a></li><li><a href="/learn-wgpu/beginner/tutorial3-pipeline/" class="sidebar-link">파이프라인</a></li><li><a href="/learn-wgpu/beginner/tutorial4-buffer/" class="sidebar-link">버퍼와 인덱스</a></li><li><a href="/learn-wgpu/beginner/tutorial5-textures/" class="sidebar-link">텍스처와 바인드 그룹</a></li><li><a href="/learn-wgpu/beginner/tutorial6-uniforms/" class="sidebar-link">유니폼 버퍼와 3D 카메라</a></li><li><a href="/learn-wgpu/beginner/tutorial7-instancing/" class="sidebar-link">인스턴싱(Instancing)</a></li><li><a href="/learn-wgpu/beginner/tutorial8-depth/" class="sidebar-link">깊이 버퍼 (The Depth Buffer)</a></li><li><a href="/learn-wgpu/beginner/tutorial9-models/" class="sidebar-link">모델 로딩</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>Intermediate</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/learn-wgpu/intermediate/tutorial10-lighting/" class="sidebar-link">조명 다루기</a></li><li><a href="/learn-wgpu/intermediate/tutorial11-normals/" class="sidebar-link">노멀 매핑 (Normal Mapping)</a></li><li><a href="/learn-wgpu/intermediate/tutorial12-camera/" class="sidebar-link">더 나은 카메라</a></li><li><a href="/learn-wgpu/intermediate/tutorial13-hdr/" aria-current="page" class="active sidebar-link">하이 다이내믹 레인지 렌더링 (High Dynamic Range Rendering)</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/learn-wgpu/intermediate/tutorial13-hdr/#하이-다이내믹-레인지란-무엇인가" class="sidebar-link">하이 다이내믹 레인지란 무엇인가?</a></li><li class="sidebar-sub-header"><a href="/learn-wgpu/intermediate/tutorial13-hdr/#hdr로-전환하기" class="sidebar-link">HDR로 전환하기</a></li><li class="sidebar-sub-header"><a href="/learn-wgpu/intermediate/tutorial13-hdr/#톤-매핑-tonemapping" class="sidebar-link">톤 매핑(Tonemapping)</a></li><li class="sidebar-sub-header"><a href="/learn-wgpu/intermediate/tutorial13-hdr/#hdr-텍스처-로딩하기" class="sidebar-link">HDR 텍스처 로딩하기</a></li><li class="sidebar-sub-header"><a href="/learn-wgpu/intermediate/tutorial13-hdr/#정거원통도법-텍스처-equirectangular-textures" class="sidebar-link">정거원통도법 텍스처 (Equirectangular textures)</a></li><li class="sidebar-sub-header"><a href="/learn-wgpu/intermediate/tutorial13-hdr/#큐브맵-cube-maps" class="sidebar-link">큐브맵 (Cube Maps)</a></li><li class="sidebar-sub-header"><a href="/learn-wgpu/intermediate/tutorial13-hdr/#컴퓨트-셰이더-compute-shaders" class="sidebar-link">컴퓨트 셰이더 (Compute shaders)</a></li><li class="sidebar-sub-header"><a href="/learn-wgpu/intermediate/tutorial13-hdr/#컴퓨트-셰이더" class="sidebar-link">컴퓨트 셰이더</a></li><li class="sidebar-sub-header"><a href="/learn-wgpu/intermediate/tutorial13-hdr/#스카이박스-skybox" class="sidebar-link">스카이박스 (Skybox)</a></li><li class="sidebar-sub-header"><a href="/learn-wgpu/intermediate/tutorial13-hdr/#반사-reflections" class="sidebar-link">반사 (Reflections)</a></li><li class="sidebar-sub-header"><a href="/learn-wgpu/intermediate/tutorial13-hdr/#webgpu에서-출력이-너무-어두운가요" class="sidebar-link">WebGPU에서 출력이 너무 어두운가요?</a></li><li class="sidebar-sub-header"><a href="/learn-wgpu/intermediate/tutorial13-hdr/#데모" class="sidebar-link">데모</a></li></ul></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Showcase</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>News</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="하이-다이내믹-레인지-렌더링-high-dynamic-range-rendering"><a href="#하이-다이내믹-레인지-렌더링-high-dynamic-range-rendering" class="header-anchor">#</a> 하이 다이내믹 레인지 렌더링 (High Dynamic Range Rendering)</h1> <p>지금까지 우리는 sRGB 색상 공간을 사용하여 씬(scene)을 렌더링해 왔습니다. 이것도 괜찮지만, 조명을 다루는 데 한계가 있습니다. 우리는 (대부분의 시스템에서) 서피스 텍스처(surface texture)로 <code>TextureFormat::Bgra8UnormSrgb</code>를 사용하고 있습니다. 이는 빨강, 초록, 파랑, 알파 각 채널에 8비트를 사용한다는 의미입니다. 채널들은 0에서 255 사이의 정수로 저장되지만, 0.0과 1.0 사이의 부동 소수점 값으로 변환됩니다. 요약하자면, 8비트 텍스처를 사용하면 각 채널에서 256개의 가능한 값만 얻을 수 있다는 것입니다.</p> <p>여기서 핵심은 이 정밀도의 대부분이 씬의 어두운 값을 표현하는 데 사용된다는 점입니다. 이는 전구와 같은 밝은 물체가 태양과 같은 극도로 밝은 물체와 동일한 값을 갖게 된다는 것을 의미합니다. 이러한 부정확성 때문에 사실적인 조명을 올바르게 구현하기가 어렵습니다. 이 때문에, 우리는 씬에 더 많은 유연성을 부여하고 물리 기반 렌더링(Physically Based Rendering)과 같은 고급 기술을 활용할 수 있도록 렌더링 시스템을 하이 다이내믹 레인지(HDR)를 사용하도록 전환할 것입니다.</p> <h2 id="하이-다이내믹-레인지란-무엇인가"><a href="#하이-다이내믹-레인지란-무엇인가" class="header-anchor">#</a> 하이 다이내믹 레인지란 무엇인가?</h2> <p>일반적으로 하이 다이내믹 레인지(HDR) 텍스처는 픽셀당 더 많은 비트를 가진 텍스처입니다. 또한, HDR 텍스처는 정수 값 대신 부동 소수점 값으로 저장됩니다. 이는 텍스처가 1.0보다 큰 밝기 값을 가질 수 있음을 의미하며, 따라서 더 밝은 객체들의 다이내믹 레인지를 가질 수 있습니다.</p> <h2 id="hdr로-전환하기"><a href="#hdr로-전환하기" class="header-anchor">#</a> HDR로 전환하기</h2> <p>이 글을 쓰는 시점에서 wgpu는 <code>TextureFormat::Rgba16Float</code>와 같은 부동 소수점 포맷을 서피스 텍스처 포맷으로 사용하는 것을 허용하지 않습니다 (모든 모니터가 이를 지원하는 것도 아닙니다). 따라서 우리는 씬을 HDR 포맷으로 렌더링한 다음, 톤 매핑(tonemapping)이라는 기술을 사용하여 그 값들을 <code>TextureFormat::Bgra8UnormSrgb</code>와 같은 지원되는 포맷으로 변환해야 합니다.</p> <div class="note"><p>wgpu에서 HDR 서피스 텍스처 지원을 구현하는 것에 대한 몇 가지 논의가 있습니다. 이 노력에 기여하고 싶다면 다음 GitHub 이슈를 참고하세요: https://github.com/gfx-rs/wgpu/issues/2920</p></div> <p>하지만 그 전에, 렌더링에 HDR 텍스처를 사용하도록 전환해야 합니다.</p> <p>먼저, <code>hdr.rs</code>라는 파일을 만들고 다음 코드를 넣겠습니다:</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">use</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">Operations</span><span class="token punctuation">;</span>

<span class="token keyword">use</span> <span class="token keyword">crate</span><span class="token punctuation">::</span><span class="token punctuation">{</span>create_render_pipeline<span class="token punctuation">,</span> texture<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">/// 렌더 텍스처를 소유하고 톤 매핑을 제어합니다.</span>
<span class="token keyword">pub</span> <span class="token keyword">struct</span> <span class="token type-definition class-name">HdrPipeline</span> <span class="token punctuation">{</span>
    pipeline<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">RenderPipeline</span><span class="token punctuation">,</span>
    bind_group<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">BindGroup</span><span class="token punctuation">,</span>
    texture<span class="token punctuation">:</span> <span class="token namespace">texture<span class="token punctuation">::</span></span><span class="token class-name">Texture</span><span class="token punctuation">,</span>
    width<span class="token punctuation">:</span> <span class="token keyword">u32</span><span class="token punctuation">,</span>
    height<span class="token punctuation">:</span> <span class="token keyword">u32</span><span class="token punctuation">,</span>
    format<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">TextureFormat</span><span class="token punctuation">,</span>
    layout<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">BindGroupLayout</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">impl</span> <span class="token class-name">HdrPipeline</span> <span class="token punctuation">{</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">new</span><span class="token punctuation">(</span>device<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">Device</span><span class="token punctuation">,</span> config<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">SurfaceConfiguration</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token keyword">Self</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> width <span class="token operator">=</span> config<span class="token punctuation">.</span>width<span class="token punctuation">;</span>
        <span class="token keyword">let</span> height <span class="token operator">=</span> config<span class="token punctuation">.</span>height<span class="token punctuation">;</span>

        <span class="token comment">// `Rgba32Float`를 사용할 수도 있지만, 렌더링을 위해</span>
        <span class="token comment">// 몇 가지 추가 기능을 활성화해야 합니다.</span>
        <span class="token keyword">let</span> format <span class="token operator">=</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">TextureFormat</span><span class="token punctuation">::</span><span class="token class-name">Rgba16Float</span><span class="token punctuation">;</span>

        <span class="token keyword">let</span> texture <span class="token operator">=</span> <span class="token namespace">texture<span class="token punctuation">::</span></span><span class="token class-name">Texture</span><span class="token punctuation">::</span><span class="token function">create_2d_texture</span><span class="token punctuation">(</span>
            device<span class="token punctuation">,</span>
            width<span class="token punctuation">,</span>
            height<span class="token punctuation">,</span>
            format<span class="token punctuation">,</span>
            <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">TextureUsages</span><span class="token punctuation">::</span><span class="token constant">TEXTURE_BINDING</span> <span class="token operator">|</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">TextureUsages</span><span class="token punctuation">::</span><span class="token constant">RENDER_ATTACHMENT</span><span class="token punctuation">,</span>
            <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">FilterMode</span><span class="token punctuation">::</span><span class="token class-name">Nearest</span><span class="token punctuation">,</span>
            <span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token string">&quot;Hdr::texture&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">let</span> layout <span class="token operator">=</span> device<span class="token punctuation">.</span><span class="token function">create_bind_group_layout</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">BindGroupLayoutDescriptor</span> <span class="token punctuation">{</span>
            label<span class="token punctuation">:</span> <span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token string">&quot;Hdr::layout&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            entries<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token punctuation">[</span>
                <span class="token comment">// 이것이 HDR 텍스처입니다.</span>
                <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">BindGroupLayoutEntry</span> <span class="token punctuation">{</span>
                    binding<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
                    visibility<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">ShaderStages</span><span class="token punctuation">::</span><span class="token constant">FRAGMENT</span><span class="token punctuation">,</span>
                    ty<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">BindingType</span><span class="token punctuation">::</span><span class="token class-name">Texture</span> <span class="token punctuation">{</span>
                        sample_type<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">TextureSampleType</span><span class="token punctuation">::</span><span class="token class-name">Float</span> <span class="token punctuation">{</span> filterable<span class="token punctuation">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
                        view_dimension<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">TextureViewDimension</span><span class="token punctuation">::</span><span class="token constant">D2</span><span class="token punctuation">,</span>
                        multisampled<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
                    <span class="token punctuation">}</span><span class="token punctuation">,</span>
                    count<span class="token punctuation">:</span> <span class="token class-name">None</span><span class="token punctuation">,</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">BindGroupLayoutEntry</span> <span class="token punctuation">{</span>
                    binding<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
                    visibility<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">ShaderStages</span><span class="token punctuation">::</span><span class="token constant">FRAGMENT</span><span class="token punctuation">,</span>
                    ty<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">BindingType</span><span class="token punctuation">::</span><span class="token class-name">Sampler</span><span class="token punctuation">(</span><span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">SamplerBindingType</span><span class="token punctuation">::</span><span class="token class-name">Filtering</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    count<span class="token punctuation">:</span> <span class="token class-name">None</span><span class="token punctuation">,</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> bind_group <span class="token operator">=</span> device<span class="token punctuation">.</span><span class="token function">create_bind_group</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">BindGroupDescriptor</span> <span class="token punctuation">{</span>
            label<span class="token punctuation">:</span> <span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token string">&quot;Hdr::bind_group&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            layout<span class="token punctuation">:</span> <span class="token operator">&amp;</span>layout<span class="token punctuation">,</span>
            entries<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token punctuation">[</span>
                <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">BindGroupEntry</span> <span class="token punctuation">{</span>
                    binding<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
                    resource<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">BindingResource</span><span class="token punctuation">::</span><span class="token class-name">TextureView</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>texture<span class="token punctuation">.</span>view<span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">BindGroupEntry</span> <span class="token punctuation">{</span>
                    binding<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
                    resource<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">BindingResource</span><span class="token punctuation">::</span><span class="token class-name">Sampler</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>texture<span class="token punctuation">.</span>sampler<span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 셰이더는 다음에 다룰 것입니다.</span>
        <span class="token keyword">let</span> shader <span class="token operator">=</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token macro property">include_wgsl!</span><span class="token punctuation">(</span><span class="token string">&quot;hdr.wgsl&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> pipeline_layout <span class="token operator">=</span> device<span class="token punctuation">.</span><span class="token function">create_pipeline_layout</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">PipelineLayoutDescriptor</span> <span class="token punctuation">{</span>
            label<span class="token punctuation">:</span> <span class="token class-name">None</span><span class="token punctuation">,</span>
            bind_group_layouts<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token punctuation">[</span><span class="token operator">&amp;</span>layout<span class="token punctuation">]</span><span class="token punctuation">,</span>
            push_constant_ranges<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">let</span> pipeline <span class="token operator">=</span> <span class="token function">create_render_pipeline</span><span class="token punctuation">(</span>
            device<span class="token punctuation">,</span>
            <span class="token operator">&amp;</span>pipeline_layout<span class="token punctuation">,</span>
            config<span class="token punctuation">.</span>format<span class="token punctuation">.</span><span class="token function">add_srgb_suffix</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token class-name">None</span><span class="token punctuation">,</span>
            <span class="token comment">// 셰이더에서 수학을 사용하여 정점 데이터를 생성할 것이므로,</span>
            <span class="token comment">// 정점 버퍼는 필요 없습니다.</span>
            <span class="token operator">&amp;</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">PrimitiveTopology</span><span class="token punctuation">::</span><span class="token class-name">TriangleList</span><span class="token punctuation">,</span>
            shader<span class="token punctuation">,</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">Self</span> <span class="token punctuation">{</span>
            pipeline<span class="token punctuation">,</span>
            bind_group<span class="token punctuation">,</span>
            layout<span class="token punctuation">,</span>
            texture<span class="token punctuation">,</span>
            width<span class="token punctuation">,</span>
            height<span class="token punctuation">,</span>
            format<span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/// HDR 텍스처 크기 조정</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">resize</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> device<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">Device</span><span class="token punctuation">,</span> width<span class="token punctuation">:</span> <span class="token keyword">u32</span><span class="token punctuation">,</span> height<span class="token punctuation">:</span> <span class="token keyword">u32</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>texture <span class="token operator">=</span> <span class="token namespace">texture<span class="token punctuation">::</span></span><span class="token class-name">Texture</span><span class="token punctuation">::</span><span class="token function">create_2d_texture</span><span class="token punctuation">(</span>
            device<span class="token punctuation">,</span>
            width<span class="token punctuation">,</span>
            height<span class="token punctuation">,</span>
            <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">TextureFormat</span><span class="token punctuation">::</span><span class="token class-name">Rgba16Float</span><span class="token punctuation">,</span>
            <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">TextureUsages</span><span class="token punctuation">::</span><span class="token constant">TEXTURE_BINDING</span> <span class="token operator">|</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">TextureUsages</span><span class="token punctuation">::</span><span class="token constant">RENDER_ATTACHMENT</span><span class="token punctuation">,</span>
            <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">FilterMode</span><span class="token punctuation">::</span><span class="token class-name">Nearest</span><span class="token punctuation">,</span>
            <span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token string">&quot;Hdr::texture&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>bind_group <span class="token operator">=</span> device<span class="token punctuation">.</span><span class="token function">create_bind_group</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">BindGroupDescriptor</span> <span class="token punctuation">{</span>
            label<span class="token punctuation">:</span> <span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token string">&quot;Hdr::bind_group&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            layout<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">.</span>layout<span class="token punctuation">,</span>
            entries<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token punctuation">[</span>
                <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">BindGroupEntry</span> <span class="token punctuation">{</span>
                    binding<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
                    resource<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">BindingResource</span><span class="token punctuation">::</span><span class="token class-name">TextureView</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">.</span>texture<span class="token punctuation">.</span>view<span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">BindGroupEntry</span> <span class="token punctuation">{</span>
                    binding<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
                    resource<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">BindingResource</span><span class="token punctuation">::</span><span class="token class-name">Sampler</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">.</span>texture<span class="token punctuation">.</span>sampler<span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>width <span class="token operator">=</span> width<span class="token punctuation">;</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>height <span class="token operator">=</span> height<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/// HDR 텍스처를 노출합니다.</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">view</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token operator">&amp;</span><span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">TextureView</span> <span class="token punctuation">{</span>
        <span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">.</span>texture<span class="token punctuation">.</span>view
    <span class="token punctuation">}</span>

    <span class="token comment">/// HDR 텍스처의 포맷</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">format</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">TextureFormat</span> <span class="token punctuation">{</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>format
    <span class="token punctuation">}</span>

    <span class="token comment">/// 이 메서드는 내부 HDR 텍스처를 매개변수로 제공된</span>
    <span class="token comment">/// [TextureView]에 렌더링합니다.</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">process</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">,</span> encoder<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">CommandEncoder</span><span class="token punctuation">,</span> output<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">TextureView</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> <span class="token keyword">mut</span> pass <span class="token operator">=</span> encoder<span class="token punctuation">.</span><span class="token function">begin_render_pass</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">RenderPassDescriptor</span> <span class="token punctuation">{</span>
            label<span class="token punctuation">:</span> <span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token string">&quot;Hdr::process&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            color_attachments<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token punctuation">[</span><span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">RenderPassColorAttachment</span> <span class="token punctuation">{</span>
                view<span class="token punctuation">:</span> <span class="token operator">&amp;</span>output<span class="token punctuation">,</span>
                resolve_target<span class="token punctuation">:</span> <span class="token class-name">None</span><span class="token punctuation">,</span>
                ops<span class="token punctuation">:</span> <span class="token class-name">Operations</span> <span class="token punctuation">{</span>
                    load<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">LoadOp</span><span class="token punctuation">::</span><span class="token class-name">Load</span><span class="token punctuation">,</span>
                    store<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">StoreOp</span><span class="token punctuation">::</span><span class="token class-name">Store</span><span class="token punctuation">,</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            depth_stencil_attachment<span class="token punctuation">:</span> <span class="token class-name">None</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        pass<span class="token punctuation">.</span><span class="token function">set_pipeline</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">.</span>pipeline<span class="token punctuation">)</span><span class="token punctuation">;</span>
        pass<span class="token punctuation">.</span><span class="token function">set_bind_group</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">.</span>bind_group<span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        pass<span class="token punctuation">.</span><span class="token function">draw</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">..</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">..</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p><code>create_render_pipeline</code>에 새로운 매개변수를 추가한 것을 눈치채셨을 겁니다. 해당 함수의 변경 사항은 다음과 같습니다:</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">fn</span> <span class="token function-definition function">create_render_pipeline</span><span class="token punctuation">(</span>
    device<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">Device</span><span class="token punctuation">,</span>
    layout<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">PipelineLayout</span><span class="token punctuation">,</span>
    color_format<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">TextureFormat</span><span class="token punctuation">,</span>
    depth_format<span class="token punctuation">:</span> <span class="token class-name">Option</span><span class="token operator">&lt;</span><span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">TextureFormat</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
    vertex_layouts<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token punctuation">[</span><span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">VertexBufferLayout</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    topology<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">PrimitiveTopology</span><span class="token punctuation">,</span> <span class="token comment">// NEW!</span>
    shader<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">ShaderModuleDescriptor</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">RenderPipeline</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> shader <span class="token operator">=</span> device<span class="token punctuation">.</span><span class="token function">create_shader_module</span><span class="token punctuation">(</span>shader<span class="token punctuation">)</span><span class="token punctuation">;</span>

    device<span class="token punctuation">.</span><span class="token function">create_render_pipeline</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">RenderPipelineDescriptor</span> <span class="token punctuation">{</span>
        <span class="token comment">// ...</span>
        primitive<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">PrimitiveState</span> <span class="token punctuation">{</span>
            topology<span class="token punctuation">,</span> <span class="token comment">// NEW!</span>
            <span class="token comment">// ...</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token comment">// ...</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="톤-매핑-tonemapping"><a href="#톤-매핑-tonemapping" class="header-anchor">#</a> 톤 매핑(Tonemapping)</h2> <p>톤 매핑 과정은 HDR 이미지를 가져와 표준 다이내믹 레인지(SDR)로 변환하는 것이며, 보통 sRGB를 사용합니다. 사용하는 톤 매핑 곡선은 궁극적으로 예술적 필요에 따라 결정되지만, 이 튜토리얼에서는 게임 산업과 영화 산업 전반에 걸쳐 널리 사용되는 아카데미 컬러 인코딩 시스템(Academy Color Encoding System, ACES)이라는 인기 있는 방법을 사용하겠습니다.</p> <p>이제 셰이더로 넘어가 봅시다. <code>hdr.wgsl</code>이라는 파일을 만들고 다음 코드를 추가하세요:</p> <div class="language-wgsl extra-class"><pre class="language-wgsl"><code><span class="token comment">// HDR 값을 선형 값으로 매핑합니다.</span>
<span class="token comment">// http://www.oscars.org/science-technology/sci-tech-projects/aces 기반</span>
<span class="token keyword">fn</span> <span class="token functions function">aces_tone_map</span><span class="token punctuation">(</span>hdr<span class="token punctuation">:</span> <span class="token builtin">vec3</span><span class="token punctuation">&lt;</span><span class="token builtin">f32</span><span class="token punctuation">&gt;</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token builtin">vec3</span><span class="token punctuation">&lt;</span><span class="token builtin">f32</span><span class="token punctuation">&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> m1 <span class="token operator">=</span> <span class="token builtin">mat3x3</span><span class="token punctuation">(</span>
        <span class="token decimal-float-literal number">0.59719</span><span class="token punctuation">,</span> <span class="token decimal-float-literal number">0.07600</span><span class="token punctuation">,</span> <span class="token decimal-float-literal number">0.02840</span><span class="token punctuation">,</span>
        <span class="token decimal-float-literal number">0.35458</span><span class="token punctuation">,</span> <span class="token decimal-float-literal number">0.90834</span><span class="token punctuation">,</span> <span class="token decimal-float-literal number">0.13383</span><span class="token punctuation">,</span>
        <span class="token decimal-float-literal number">0.04823</span><span class="token punctuation">,</span> <span class="token decimal-float-literal number">0.01566</span><span class="token punctuation">,</span> <span class="token decimal-float-literal number">0.83777</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> m2 <span class="token operator">=</span> <span class="token builtin">mat3x3</span><span class="token punctuation">(</span>
        <span class="token decimal-float-literal number">1.60475</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token decimal-float-literal number">0.10208</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token decimal-float-literal number">0.00327</span><span class="token punctuation">,</span>
        <span class="token operator">-</span><span class="token decimal-float-literal number">0.53108</span><span class="token punctuation">,</span>  <span class="token decimal-float-literal number">1.10813</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token decimal-float-literal number">0.07276</span><span class="token punctuation">,</span>
        <span class="token operator">-</span><span class="token decimal-float-literal number">0.07367</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token decimal-float-literal number">0.00605</span><span class="token punctuation">,</span>  <span class="token decimal-float-literal number">1.07602</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> v <span class="token operator">=</span> m1 <span class="token operator">*</span> hdr<span class="token punctuation">;</span>
    <span class="token keyword">let</span> a <span class="token operator">=</span> v <span class="token operator">*</span> <span class="token punctuation">(</span>v <span class="token operator">+</span> <span class="token decimal-float-literal number">0.0245786</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token decimal-float-literal number">0.000090537</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> b <span class="token operator">=</span> v <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token decimal-float-literal number">0.983729</span> <span class="token operator">*</span> v <span class="token operator">+</span> <span class="token decimal-float-literal number">0.4329510</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token decimal-float-literal number">0.238081</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token builtin">clamp</span><span class="token punctuation">(</span>m2 <span class="token operator">*</span> <span class="token punctuation">(</span>a <span class="token operator">/</span> b<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">vec3</span><span class="token punctuation">(</span><span class="token decimal-float-literal number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">vec3</span><span class="token punctuation">(</span><span class="token decimal-float-literal number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">struct</span> <span class="token class-name">VertexOutput</span> <span class="token punctuation">{</span>
    <span class="token punctuation">@</span><span class="token attributes attr-name">location</span><span class="token punctuation">(</span><span class="token int-literal number">0</span><span class="token punctuation">)</span> uv<span class="token punctuation">:</span> <span class="token builtin">vec2</span><span class="token punctuation">&lt;</span><span class="token builtin">f32</span><span class="token punctuation">&gt;</span><span class="token punctuation">,</span>
    <span class="token punctuation">@</span><span class="token builtin-attribute"><span class="token attribute attr-name">builtin</span><span class="token punctuation">(</span><span class="token built-in-values attr-value">position</span><span class="token punctuation">)</span></span> clip_position<span class="token punctuation">:</span> <span class="token builtin">vec4</span><span class="token punctuation">&lt;</span><span class="token builtin">f32</span><span class="token punctuation">&gt;</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token punctuation">@</span><span class="token attributes attr-name">vertex</span>
<span class="token keyword">fn</span> <span class="token functions function">vs_main</span><span class="token punctuation">(</span>
    <span class="token punctuation">@</span><span class="token builtin-attribute"><span class="token attribute attr-name">builtin</span><span class="token punctuation">(</span><span class="token built-in-values attr-value">vertex_index</span><span class="token punctuation">)</span></span> vi<span class="token punctuation">:</span> <span class="token builtin">u32</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token class-name">VertexOutput</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> out<span class="token punctuation">:</span> <span class="token class-name">VertexOutput</span><span class="token punctuation">;</span>
    <span class="token comment">// 화면 전체를 덮는 삼각형을 생성합니다.</span>
    out<span class="token punctuation">.</span>uv <span class="token operator">=</span> <span class="token builtin">vec2</span><span class="token punctuation">&lt;</span><span class="token builtin">f32</span><span class="token punctuation">&gt;</span><span class="token punctuation">(</span>
        <span class="token builtin">f32</span><span class="token punctuation">(</span><span class="token punctuation">(</span>vi <span class="token operator">&lt;&lt;</span> <span class="token int-literal number">1u</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token int-literal number">2u</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token builtin">f32</span><span class="token punctuation">(</span>vi <span class="token operator">&amp;</span> <span class="token int-literal number">2u</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    out<span class="token punctuation">.</span>clip_position <span class="token operator">=</span> <span class="token builtin">vec4</span><span class="token punctuation">&lt;</span><span class="token builtin">f32</span><span class="token punctuation">&gt;</span><span class="token punctuation">(</span>out<span class="token punctuation">.</span>uv <span class="token operator">*</span> <span class="token decimal-float-literal number">2.0</span> <span class="token operator">-</span> <span class="token decimal-float-literal number">1.0</span><span class="token punctuation">,</span> <span class="token decimal-float-literal number">0.0</span><span class="token punctuation">,</span> <span class="token decimal-float-literal number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 이미지가 뒤집히지 않도록 y 좌표를 반전시켜야 합니다.</span>
    out<span class="token punctuation">.</span>uv<span class="token punctuation">.</span>y <span class="token operator">=</span> <span class="token decimal-float-literal number">1.0</span> <span class="token operator">-</span> out<span class="token punctuation">.</span>uv<span class="token punctuation">.</span>y<span class="token punctuation">;</span>
    <span class="token keyword">return</span> out<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token punctuation">@</span><span class="token attributes attr-name">group</span><span class="token punctuation">(</span><span class="token int-literal number">0</span><span class="token punctuation">)</span>
<span class="token punctuation">@</span><span class="token attributes attr-name">binding</span><span class="token punctuation">(</span><span class="token int-literal number">0</span><span class="token punctuation">)</span>
<span class="token keyword">var</span> hdr_image<span class="token punctuation">:</span> <span class="token builtin">texture_2d</span><span class="token punctuation">&lt;</span><span class="token builtin">f32</span><span class="token punctuation">&gt;</span><span class="token punctuation">;</span>

<span class="token punctuation">@</span><span class="token attributes attr-name">group</span><span class="token punctuation">(</span><span class="token int-literal number">0</span><span class="token punctuation">)</span>
<span class="token punctuation">@</span><span class="token attributes attr-name">binding</span><span class="token punctuation">(</span><span class="token int-literal number">1</span><span class="token punctuation">)</span>
<span class="token keyword">var</span> hdr_sampler<span class="token punctuation">:</span> <span class="token builtin">sampler</span><span class="token punctuation">;</span>

<span class="token punctuation">@</span><span class="token attributes attr-name">fragment</span>
<span class="token keyword">fn</span> <span class="token functions function">fs_main</span><span class="token punctuation">(</span>vs<span class="token punctuation">:</span> <span class="token class-name">VertexOutput</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">@</span><span class="token attributes attr-name">location</span><span class="token punctuation">(</span><span class="token int-literal number">0</span><span class="token punctuation">)</span> <span class="token builtin">vec4</span><span class="token punctuation">&lt;</span><span class="token builtin">f32</span><span class="token punctuation">&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> hdr <span class="token operator">=</span> <span class="token builtin">textureSample</span><span class="token punctuation">(</span>hdr_image<span class="token punctuation">,</span> hdr_sampler<span class="token punctuation">,</span> vs<span class="token punctuation">.</span>uv<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> sdr <span class="token operator">=</span> <span class="token function-calls function">aces_tone_map</span><span class="token punctuation">(</span>hdr<span class="token punctuation">.</span>rgb<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token builtin">vec4</span><span class="token punctuation">(</span>sdr<span class="token punctuation">,</span> hdr<span class="token punctuation">.</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>이제 이들을 배치했으니 핵심 렌더 파이프라인에서 HDR 텍스처를 사용해 봅시다. 먼저, <code>State</code>에 새로운 <code>HdrPipeline</code>을 추가해야 합니다:</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token comment">// lib.rs</span>

<span class="token keyword">mod</span> <span class="token module-declaration namespace">hdr</span><span class="token punctuation">;</span> <span class="token comment">// NEW!</span>

<span class="token comment">// ...</span>

<span class="token keyword">pub</span> <span class="token keyword">struct</span> <span class="token type-definition class-name">State</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
    <span class="token comment">// NEW!</span>
    hdr<span class="token punctuation">:</span> <span class="token namespace">hdr<span class="token punctuation">::</span></span><span class="token class-name">HdrPipeline</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">impl</span> <span class="token class-name">State</span> <span class="token punctuation">{</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">new</span><span class="token punctuation">(</span>window<span class="token punctuation">:</span> <span class="token class-name">Window</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token namespace">anyhow<span class="token punctuation">::</span></span><span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token keyword">Self</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
        <span class="token comment">// ...</span>
        <span class="token comment">// NEW!</span>
        <span class="token keyword">let</span> hdr <span class="token operator">=</span> <span class="token namespace">hdr<span class="token punctuation">::</span></span><span class="token class-name">HdrPipeline</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>device<span class="token punctuation">,</span> <span class="token operator">&amp;</span>config<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// ...</span>

        <span class="token keyword">Self</span> <span class="token punctuation">{</span>
            <span class="token comment">// ...</span>
            hdr<span class="token punctuation">,</span> <span class="token comment">// NEW!</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>그런 다음, 창 크기를 조절할 때 <code>HdrPipeline</code>의 <code>resize()</code>를 호출해야 합니다:</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">fn</span> <span class="token function-definition function">resize</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> width<span class="token punctuation">:</span> <span class="token keyword">u32</span><span class="token punctuation">,</span> height<span class="token punctuation">:</span> <span class="token keyword">u32</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// UPDATED!</span>
    <span class="token keyword">if</span> width <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> height <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token punctuation">{</span>
        <span class="token comment">// ...</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>hdr
            <span class="token punctuation">.</span><span class="token function">resize</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">.</span>device<span class="token punctuation">,</span> new_size<span class="token punctuation">.</span>width<span class="token punctuation">,</span> new_size<span class="token punctuation">.</span>height<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// ...</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>다음으로, <code>render()</code>에서 <code>RenderPass</code>가 서피스 텍스처 대신 HDR 텍스처를 사용하도록 전환해야 합니다:</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token comment">// render()</span>
<span class="token keyword">let</span> <span class="token keyword">mut</span> render_pass <span class="token operator">=</span> encoder<span class="token punctuation">.</span><span class="token function">begin_render_pass</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">RenderPassDescriptor</span> <span class="token punctuation">{</span>
    label<span class="token punctuation">:</span> <span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token string">&quot;Render Pass&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    color_attachments<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token punctuation">[</span><span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">RenderPassColorAttachment</span> <span class="token punctuation">{</span>
        view<span class="token punctuation">:</span> <span class="token keyword">self</span><span class="token punctuation">.</span>hdr<span class="token punctuation">.</span><span class="token function">view</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// UPDATED!</span>
        resolve_target<span class="token punctuation">:</span> <span class="token class-name">None</span><span class="token punctuation">,</span>
        ops<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">Operations</span> <span class="token punctuation">{</span>
            load<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">LoadOp</span><span class="token punctuation">::</span><span class="token class-name">Clear</span><span class="token punctuation">(</span><span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">Color</span> <span class="token punctuation">{</span>
                r<span class="token punctuation">:</span> <span class="token number">0.1</span><span class="token punctuation">,</span>
                g<span class="token punctuation">:</span> <span class="token number">0.2</span><span class="token punctuation">,</span>
                b<span class="token punctuation">:</span> <span class="token number">0.3</span><span class="token punctuation">,</span>
                a<span class="token punctuation">:</span> <span class="token number">1.0</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            store<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">StoreOp</span><span class="token punctuation">::</span><span class="token class-name">Store</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    depth_stencil_attachment<span class="token punctuation">:</span> <span class="token class-name">Some</span><span class="token punctuation">(</span>
        <span class="token comment">// ...</span>
    <span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>마지막으로, 프레임의 모든 객체를 그린 후, 서피스 텍스처를 출력으로 사용하여 톤매퍼를 실행할 수 있습니다:</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token comment">// NEW!</span>
<span class="token comment">// 톤 매핑 적용</span>
<span class="token keyword">self</span><span class="token punctuation">.</span>hdr<span class="token punctuation">.</span><span class="token function">process</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> encoder<span class="token punctuation">,</span> <span class="token operator">&amp;</span>view<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>전환은 매우 쉽습니다. HDR을 사용하기 전의 이미지입니다:</p> <p><img src="/learn-wgpu/assets/img/before-hdr.18896278.png" alt="before hdr"></p> <p>HDR을 구현한 후의 모습입니다:</p> <p><img src="/learn-wgpu/assets/img/after-hdr.81564a1d.png" alt="after hdr"></p> <h2 id="hdr-텍스처-로딩하기"><a href="#hdr-텍스처-로딩하기" class="header-anchor">#</a> HDR 텍스처 로딩하기</h2> <p>이제 HDR 렌더 버퍼가 있으니, HDR 텍스처를 최대한 활용할 수 있습니다. HDR 텍스처의 주요 용도 중 하나는 환경 맵(environment map) 형태로 조명 정보를 저장하는 것입니다.</p> <p>이 맵은 객체를 비추고, 반사를 표시하며, 스카이박스를 만드는 데 사용될 수 있습니다. HDR 텍스처를 사용하여 스카이박스를 만들 것이지만, 그 전에 환경 맵이 어떻게 저장되는지에 대해 이야기해야 합니다.</p> <h2 id="정거원통도법-텍스처-equirectangular-textures"><a href="#정거원통도법-텍스처-equirectangular-textures" class="header-anchor">#</a> 정거원통도법 텍스처 (Equirectangular textures)</h2> <p>정거원통도법 텍스처는 정거원통도법(equirectangular projection)이라는 것을 사용하여 구를 직사각형 표면에 펼쳐놓은 텍스처입니다. 이 지구 지도는 이 투영법의 한 예입니다.</p> <p><img src="https://upload.wikimedia.org/wikipedia/commons/thumb/8/83/Equirectangular_projection_SW.jpg/1024px-Equirectangular_projection_SW.jpg" alt="map of the earth"></p> <p>이 투영법은 구의 경도 값을 텍스처의 수평 좌표에 매핑합니다. 위도 값은 수직 좌표에 매핑됩니다. 이는 텍스처의 수직 중앙이 구의 적도(위도 0°), 수평 중앙이 본초 자오선(경도 0°), 텍스처의 왼쪽과 오른쪽 가장자리가 대척 자오선(경도 +180°/-180°), 텍스처의 위쪽과 아래쪽 가장자리가 각각 북극(위도 90°)과 남극(위도 -90°)이라는 것을 의미합니다.</p> <p><img src="/learn-wgpu/assets/img/equirectangular.c308e566.svg" alt="equirectangular diagram"></p> <p>이 간단한 투영법은 사용하기 쉬워 구형 텍스처를 저장하는 데 가장 인기 있는 투영법 중 하나입니다. 아래에서 우리가 사용할 특정 환경 맵을 볼 수 있습니다.</p> <p><img src="/learn-wgpu/assets/img/kloofendal_43d_clear_puresky.d293e891.jpg" alt="equirectangular skybox"></p> <h2 id="큐브맵-cube-maps"><a href="#큐브맵-cube-maps" class="header-anchor">#</a> 큐브맵 (Cube Maps)</h2> <p>기술적으로는 정거원통도법 맵을 직접 사용할 수 있지만(올바른 좌표를 계산하기 위한 약간의 수학만 한다면), 환경 맵을 큐브맵으로 변환하는 것이 훨씬 편리합니다.</p> <div class="info"><p>큐브맵은 6개의 레이어를 가진 특별한 종류의 텍스처입니다. 각 레이어는 X, Y, Z 축에 정렬된 가상의 큐브의 다른 면에 해당합니다. 레이어는 +X, -X, +Y, -Y, +Z, -Z 순서로 저장됩니다.</p></div> <p>큐브 텍스처를 저장하기 위해 준비하기 위해 <code>texture.rs</code>에 <code>CubeTexture</code>라는 새로운 구조체를 만들겠습니다.</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">pub</span> <span class="token keyword">struct</span> <span class="token type-definition class-name">CubeTexture</span> <span class="token punctuation">{</span>
    texture<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">Texture</span><span class="token punctuation">,</span>
    sampler<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">Sampler</span><span class="token punctuation">,</span>
    view<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">TextureView</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">impl</span> <span class="token class-name">CubeTexture</span> <span class="token punctuation">{</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">create_2d</span><span class="token punctuation">(</span>
        device<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">Device</span><span class="token punctuation">,</span>
        width<span class="token punctuation">:</span> <span class="token keyword">u32</span><span class="token punctuation">,</span>
        height<span class="token punctuation">:</span> <span class="token keyword">u32</span><span class="token punctuation">,</span>
        format<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">TextureFormat</span><span class="token punctuation">,</span>
        mip_level_count<span class="token punctuation">:</span> <span class="token keyword">u32</span><span class="token punctuation">,</span>
        usage<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">TextureUsages</span><span class="token punctuation">,</span>
        mag_filter<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">FilterMode</span><span class="token punctuation">,</span>
        label<span class="token punctuation">:</span> <span class="token class-name">Option</span><span class="token operator">&lt;</span><span class="token operator">&amp;</span><span class="token keyword">str</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token keyword">Self</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> texture <span class="token operator">=</span> device<span class="token punctuation">.</span><span class="token function">create_texture</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">TextureDescriptor</span> <span class="token punctuation">{</span>
            label<span class="token punctuation">,</span>
            size<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">Extent3d</span> <span class="token punctuation">{</span>
                width<span class="token punctuation">,</span>
                height<span class="token punctuation">,</span>
                <span class="token comment">// 큐브는 6개의 면을 가지므로 6개의 레이어가 필요합니다.</span>
                depth_or_array_layers<span class="token punctuation">:</span> <span class="token number">6</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            mip_level_count<span class="token punctuation">,</span>
            sample_count<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
            dimension<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">TextureDimension</span><span class="token punctuation">::</span><span class="token constant">D2</span><span class="token punctuation">,</span>
            format<span class="token punctuation">,</span>
            usage<span class="token punctuation">,</span>
            view_formats<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">let</span> view <span class="token operator">=</span> texture<span class="token punctuation">.</span><span class="token function">create_view</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">TextureViewDescriptor</span> <span class="token punctuation">{</span>
            label<span class="token punctuation">,</span>
            dimension<span class="token punctuation">:</span> <span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">TextureViewDimension</span><span class="token punctuation">::</span><span class="token class-name">Cube</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            array_layer_count<span class="token punctuation">:</span> <span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token punctuation">..</span><span class="token class-name">Default</span><span class="token punctuation">::</span><span class="token function">default</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">let</span> sampler <span class="token operator">=</span> device<span class="token punctuation">.</span><span class="token function">create_sampler</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">SamplerDescriptor</span> <span class="token punctuation">{</span>
            label<span class="token punctuation">,</span>
            address_mode_u<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">AddressMode</span><span class="token punctuation">::</span><span class="token class-name">ClampToEdge</span><span class="token punctuation">,</span>
            address_mode_v<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">AddressMode</span><span class="token punctuation">::</span><span class="token class-name">ClampToEdge</span><span class="token punctuation">,</span>
            address_mode_w<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">AddressMode</span><span class="token punctuation">::</span><span class="token class-name">ClampToEdge</span><span class="token punctuation">,</span>
            mag_filter<span class="token punctuation">,</span>
            min_filter<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">FilterMode</span><span class="token punctuation">::</span><span class="token class-name">Nearest</span><span class="token punctuation">,</span>
            mipmap_filter<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">FilterMode</span><span class="token punctuation">::</span><span class="token class-name">Nearest</span><span class="token punctuation">,</span>
            <span class="token punctuation">..</span><span class="token class-name">Default</span><span class="token punctuation">::</span><span class="token function">default</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">Self</span> <span class="token punctuation">{</span>
            texture<span class="token punctuation">,</span>
            sampler<span class="token punctuation">,</span>
            view<span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">texture</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token operator">&amp;</span><span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">Texture</span> <span class="token punctuation">{</span> <span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">.</span>texture <span class="token punctuation">}</span>
    
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">view</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token operator">&amp;</span><span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">TextureView</span> <span class="token punctuation">{</span> <span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">.</span>view <span class="token punctuation">}</span>

    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">sampler</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token operator">&amp;</span><span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">Sampler</span> <span class="token punctuation">{</span> <span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">.</span>sampler <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre></div><p>이제 HDR을 큐브 텍스처로 로드하는 코드를 작성할 수 있습니다.</p> <h2 id="컴퓨트-셰이더-compute-shaders"><a href="#컴퓨트-셰이더-compute-shaders" class="header-anchor">#</a> 컴퓨트 셰이더 (Compute shaders)</h2> <p>지금까지는 렌더 파이프라인만 독점적으로 사용했지만, 지금이 컴퓨트 파이프라인과 그 확장인 컴퓨트 셰이더를 소개하기 좋은 시기라고 생각했습니다. 컴퓨트 파이프라인은 설정하기가 훨씬 쉽습니다. 파이프라인에 사용할 리소스, 실행할 코드, 그리고 코드를 실행할 때 GPU가 사용할 스레드 수를 알려주기만 하면 됩니다. 우리는 컴퓨트 셰이더를 사용하여 큐브 텍스처의 각 픽셀에 HDR 이미지의 색상을 부여할 것입니다.</p> <p>컴퓨트 셰이더를 사용하기 전에 wgpu에서 활성화해야 합니다. 사용하려는 기능을 지정하는 줄을 변경하여 이를 수행할 수 있습니다. <code>lib.rs</code>에서 장치를 요청하는 코드를 변경하세요:</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">let</span> <span class="token punctuation">(</span>device<span class="token punctuation">,</span> queue<span class="token punctuation">)</span> <span class="token operator">=</span> adapter
    <span class="token punctuation">.</span><span class="token function">request_device</span><span class="token punctuation">(</span>
        <span class="token operator">&amp;</span><span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">DeviceDescriptor</span> <span class="token punctuation">{</span>
            label<span class="token punctuation">:</span> <span class="token class-name">None</span><span class="token punctuation">,</span>
            <span class="token comment">// UPDATED!</span>
            features<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">Features</span><span class="token punctuation">::</span><span class="token function">all_webgpu_mask</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token comment">// UPDATED!</span>
            required_limits<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">Limits</span><span class="token punctuation">::</span><span class="token function">downlevel_defaults</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token class-name">None</span><span class="token punctuation">,</span> <span class="token comment">// Trace path</span>
    <span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token keyword">await</span>
    <span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><div class="warn"><p><code>downlevel_webgl2_defaults()</code>에서 <code>downlevel_defaults()</code>로 전환한 것을 눈치챘을 것입니다. 이는 WebGL2 지원을 중단한다는 의미입니다. 그 이유는 WebGL2가 컴퓨트 셰이더를 지원하지 않기 때문입니다. WebGPU는 컴퓨트 셰이더를 염두에 두고 만들어졌습니다. 이 글을 쓰는 시점에서 WebGPU를 지원하는 유일한 브라우저는 Chrome과 Firefox Nightly와 같은 일부 실험적인 브라우저뿐입니다.</p> <p>따라서 <code>Cargo.toml</code>에서 WebGL 기능을 제거할 것입니다. 특히 이 줄입니다:</p> <div class="language-toml extra-class"><pre class="language-toml"><code><span class="token key property">wgpu</span> <span class="token punctuation">=</span> <span class="token punctuation">{</span> <span class="token key property">version</span> <span class="token punctuation">=</span> <span class="token string">&quot;25.0&quot;</span><span class="token punctuation">,</span> <span class="token key property">features</span> <span class="token punctuation">=</span> <span class="token punctuation">[</span><span class="token string">&quot;webgl&quot;</span><span class="token punctuation">]</span><span class="token punctuation">}</span>
</code></pre></div></div> <p>이제 wgpu에 컴퓨트 셰이더를 사용하겠다고 알렸으니, <code>resource.rs</code>에 HDR 이미지를 큐브맵으로 로드하는 데 사용할 구조체를 만들어 봅시다.</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">pub</span> <span class="token keyword">struct</span> <span class="token type-definition class-name">HdrLoader</span> <span class="token punctuation">{</span>
    texture_format<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">TextureFormat</span><span class="token punctuation">,</span>
    equirect_layout<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">BindGroupLayout</span><span class="token punctuation">,</span>
    equirect_to_cubemap<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">ComputePipeline</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">impl</span> <span class="token class-name">HdrLoader</span> <span class="token punctuation">{</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">new</span><span class="token punctuation">(</span>device<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">Device</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token keyword">Self</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> module <span class="token operator">=</span> device<span class="token punctuation">.</span><span class="token function">create_shader_module</span><span class="token punctuation">(</span><span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token macro property">include_wgsl!</span><span class="token punctuation">(</span><span class="token string">&quot;equirectangular.wgsl&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> texture_format <span class="token operator">=</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">TextureFormat</span><span class="token punctuation">::</span><span class="token class-name">Rgba32Float</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> equirect_layout <span class="token operator">=</span> device<span class="token punctuation">.</span><span class="token function">create_bind_group_layout</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">BindGroupLayoutDescriptor</span> <span class="token punctuation">{</span>
            label<span class="token punctuation">:</span> <span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token string">&quot;HdrLoader::equirect_layout&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            entries<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token punctuation">[</span>
                <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">BindGroupLayoutEntry</span> <span class="token punctuation">{</span>
                    binding<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
                    visibility<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">ShaderStages</span><span class="token punctuation">::</span><span class="token constant">COMPUTE</span><span class="token punctuation">,</span>
                    ty<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">BindingType</span><span class="token punctuation">::</span><span class="token class-name">Texture</span> <span class="token punctuation">{</span>
                        sample_type<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">TextureSampleType</span><span class="token punctuation">::</span><span class="token class-name">Float</span> <span class="token punctuation">{</span> filterable<span class="token punctuation">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
                        view_dimension<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">TextureViewDimension</span><span class="token punctuation">::</span><span class="token constant">D2</span><span class="token punctuation">,</span>
                        multisampled<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
                    <span class="token punctuation">}</span><span class="token punctuation">,</span>
                    count<span class="token punctuation">:</span> <span class="token class-name">None</span><span class="token punctuation">,</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">BindGroupLayoutEntry</span> <span class="token punctuation">{</span>
                    binding<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
                    visibility<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">ShaderStages</span><span class="token punctuation">::</span><span class="token constant">COMPUTE</span><span class="token punctuation">,</span>
                    ty<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">BindingType</span><span class="token punctuation">::</span><span class="token class-name">StorageTexture</span> <span class="token punctuation">{</span>
                        access<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">StorageTextureAccess</span><span class="token punctuation">::</span><span class="token class-name">WriteOnly</span><span class="token punctuation">,</span>
                        format<span class="token punctuation">:</span> texture_format<span class="token punctuation">,</span>
                        view_dimension<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">TextureViewDimension</span><span class="token punctuation">::</span><span class="token class-name">D2Array</span><span class="token punctuation">,</span>
                    <span class="token punctuation">}</span><span class="token punctuation">,</span>
                    count<span class="token punctuation">:</span> <span class="token class-name">None</span><span class="token punctuation">,</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">let</span> pipeline_layout <span class="token operator">=</span> device<span class="token punctuation">.</span><span class="token function">create_pipeline_layout</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">PipelineLayoutDescriptor</span> <span class="token punctuation">{</span>
            label<span class="token punctuation">:</span> <span class="token class-name">None</span><span class="token punctuation">,</span>
            bind_group_layouts<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token punctuation">[</span><span class="token operator">&amp;</span>equirect_layout<span class="token punctuation">]</span><span class="token punctuation">,</span>
            push_constant_ranges<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">let</span> equirect_to_cubemap <span class="token operator">=</span>
            device<span class="token punctuation">.</span><span class="token function">create_compute_pipeline</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">ComputePipelineDescriptor</span> <span class="token punctuation">{</span>
                label<span class="token punctuation">:</span> <span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token string">&quot;equirect_to_cubemap&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                layout<span class="token punctuation">:</span> <span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pipeline_layout<span class="token punctuation">)</span><span class="token punctuation">,</span>
                module<span class="token punctuation">:</span> <span class="token operator">&amp;</span>module<span class="token punctuation">,</span>
                entry_point<span class="token punctuation">:</span> <span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token string">&quot;compute_equirect_to_cubemap&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                compilation_options<span class="token punctuation">:</span> <span class="token class-name">Default</span><span class="token punctuation">::</span><span class="token function">default</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                cache<span class="token punctuation">:</span> <span class="token class-name">None</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">Self</span> <span class="token punctuation">{</span>
            equirect_to_cubemap<span class="token punctuation">,</span>
            texture_format<span class="token punctuation">,</span>
            equirect_layout<span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">from_equirectangular_bytes</span><span class="token punctuation">(</span>
        <span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">,</span>
        device<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">Device</span><span class="token punctuation">,</span>
        queue<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">Queue</span><span class="token punctuation">,</span>
        data<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token punctuation">[</span><span class="token keyword">u8</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        dst_size<span class="token punctuation">:</span> <span class="token keyword">u32</span><span class="token punctuation">,</span>
        label<span class="token punctuation">:</span> <span class="token class-name">Option</span><span class="token operator">&lt;</span><span class="token operator">&amp;</span><span class="token keyword">str</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token namespace">anyhow<span class="token punctuation">::</span></span><span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token namespace">texture<span class="token punctuation">::</span></span><span class="token class-name">CubeTexture</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> hdr_decoder <span class="token operator">=</span> <span class="token class-name">HdrDecoder</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token class-name">Cursor</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> meta <span class="token operator">=</span> hdr_decoder<span class="token punctuation">.</span><span class="token function">metadata</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token attribute attr-name">#[cfg(not(target_arch=<span class="token string">&quot;wasm32&quot;</span>))]</span>
        <span class="token keyword">let</span> pixels <span class="token operator">=</span> <span class="token punctuation">{</span>
            <span class="token keyword">let</span> <span class="token keyword">mut</span> pixels <span class="token operator">=</span> <span class="token macro property">vec!</span><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">]</span><span class="token punctuation">;</span> meta<span class="token punctuation">.</span>width <span class="token keyword">as</span> <span class="token keyword">usize</span> <span class="token operator">*</span> meta<span class="token punctuation">.</span>height <span class="token keyword">as</span> <span class="token keyword">usize</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            hdr_decoder<span class="token punctuation">.</span><span class="token function">read_image_transform</span><span class="token punctuation">(</span>
                <span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>pix<span class="token closure-punctuation punctuation">|</span></span> <span class="token punctuation">{</span>
                    <span class="token keyword">let</span> rgb <span class="token operator">=</span> pix<span class="token punctuation">.</span><span class="token function">to_hdr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">[</span>rgb<span class="token number">.0</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> rgb<span class="token number">.0</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> rgb<span class="token number">.0</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">1.0f32</span><span class="token punctuation">]</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token operator">&amp;</span><span class="token keyword">mut</span> pixels<span class="token punctuation">[</span><span class="token punctuation">..</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>
            pixels
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token attribute attr-name">#[cfg(target_arch=<span class="token string">&quot;wasm32&quot;</span>)]</span>
        <span class="token keyword">let</span> pixels <span class="token operator">=</span> hdr_decoder<span class="token punctuation">.</span><span class="token function">read_image_native</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">?</span>
            <span class="token punctuation">.</span><span class="token function">into_iter</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>pix<span class="token closure-punctuation punctuation">|</span></span> <span class="token punctuation">{</span>
                <span class="token keyword">let</span> rgb <span class="token operator">=</span> pix<span class="token punctuation">.</span><span class="token function">to_hdr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">[</span>rgb<span class="token number">.0</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> rgb<span class="token number">.0</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> rgb<span class="token number">.0</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">1.0f32</span><span class="token punctuation">]</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">::</span><span class="token operator">&lt;</span><span class="token class-name">Vec</span><span class="token operator">&lt;</span>_<span class="token operator">&gt;&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">let</span> src <span class="token operator">=</span> <span class="token namespace">texture<span class="token punctuation">::</span></span><span class="token class-name">Texture</span><span class="token punctuation">::</span><span class="token function">create_2d_texture</span><span class="token punctuation">(</span>
            device<span class="token punctuation">,</span>
            meta<span class="token punctuation">.</span>width<span class="token punctuation">,</span>
            meta<span class="token punctuation">.</span>height<span class="token punctuation">,</span>
            <span class="token keyword">self</span><span class="token punctuation">.</span>texture_format<span class="token punctuation">,</span>
            <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">TextureUsages</span><span class="token punctuation">::</span><span class="token constant">TEXTURE_BINDING</span> <span class="token operator">|</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">TextureUsages</span><span class="token punctuation">::</span><span class="token constant">COPY_DST</span><span class="token punctuation">,</span>
            <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">FilterMode</span><span class="token punctuation">::</span><span class="token class-name">Linear</span><span class="token punctuation">,</span>
            <span class="token class-name">None</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>

        queue<span class="token punctuation">.</span><span class="token function">write_texture</span><span class="token punctuation">(</span>
            <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">TexelCopyTextureInfo</span> <span class="token punctuation">{</span>
                texture<span class="token punctuation">:</span> <span class="token operator">&amp;</span>src<span class="token punctuation">.</span>texture<span class="token punctuation">,</span>
                mip_level<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
                origin<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">Origin3d</span><span class="token punctuation">::</span><span class="token constant">ZERO</span><span class="token punctuation">,</span>
                aspect<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">TextureAspect</span><span class="token punctuation">::</span><span class="token class-name">All</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token operator">&amp;</span><span class="token namespace">bytemuck<span class="token punctuation">::</span></span><span class="token function">cast_slice</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pixels<span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">TexelCopyBufferLayout</span> <span class="token punctuation">{</span>
                offset<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
                bytes_per_row<span class="token punctuation">:</span> <span class="token class-name">Some</span><span class="token punctuation">(</span>src<span class="token punctuation">.</span>size<span class="token punctuation">.</span>width <span class="token operator">*</span> <span class="token namespace">std<span class="token punctuation">::</span>mem<span class="token punctuation">::</span></span><span class="token function">size_of</span><span class="token punctuation">::</span><span class="token operator">&lt;</span><span class="token punctuation">[</span><span class="token keyword">f32</span><span class="token punctuation">;</span> <span class="token number">4</span><span class="token punctuation">]</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token keyword">u32</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                rows_per_image<span class="token punctuation">:</span> <span class="token class-name">Some</span><span class="token punctuation">(</span>src<span class="token punctuation">.</span>size<span class="token punctuation">.</span>height<span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            src<span class="token punctuation">.</span>size<span class="token punctuation">,</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">let</span> dst <span class="token operator">=</span> <span class="token namespace">texture<span class="token punctuation">::</span></span><span class="token class-name">CubeTexture</span><span class="token punctuation">::</span><span class="token function">create_2d</span><span class="token punctuation">(</span>
            device<span class="token punctuation">,</span>
            dst_size<span class="token punctuation">,</span>
            dst_size<span class="token punctuation">,</span>
            <span class="token keyword">self</span><span class="token punctuation">.</span>texture_format<span class="token punctuation">,</span>
            <span class="token number">1</span><span class="token punctuation">,</span>
            <span class="token comment">// `dst` 텍스처에 쓸 것이므로</span>
            <span class="token comment">// `STORAGE_BINDING`을 사용해야 합니다.</span>
            <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">TextureUsages</span><span class="token punctuation">::</span><span class="token constant">STORAGE_BINDING</span>
                <span class="token operator">|</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">TextureUsages</span><span class="token punctuation">::</span><span class="token constant">TEXTURE_BINDING</span><span class="token punctuation">,</span>
            <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">FilterMode</span><span class="token punctuation">::</span><span class="token class-name">Nearest</span><span class="token punctuation">,</span>
            label<span class="token punctuation">,</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">let</span> dst_view <span class="token operator">=</span> dst<span class="token punctuation">.</span><span class="token function">texture</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">create_view</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">TextureViewDescriptor</span> <span class="token punctuation">{</span>
            label<span class="token punctuation">,</span>
            <span class="token comment">// 보통 큐브 텍스처에는 `TextureViewDimension::Cube`를</span>
            <span class="token comment">// 사용하지만, `STORAGE_BINDING`과 함께</span>
            <span class="token comment">// 해당 뷰 차원을 사용할 수 없습니다.</span>
            <span class="token comment">// 큐브 텍스처 레이어에 직접 접근해야 합니다.</span>
            dimension<span class="token punctuation">:</span> <span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">TextureViewDimension</span><span class="token punctuation">::</span><span class="token class-name">D2Array</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token punctuation">..</span><span class="token class-name">Default</span><span class="token punctuation">::</span><span class="token function">default</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">let</span> bind_group <span class="token operator">=</span> device<span class="token punctuation">.</span><span class="token function">create_bind_group</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">BindGroupDescriptor</span> <span class="token punctuation">{</span>
            label<span class="token punctuation">,</span>
            layout<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">.</span>equirect_layout<span class="token punctuation">,</span>
            entries<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token punctuation">[</span>
                <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">BindGroupEntry</span> <span class="token punctuation">{</span>
                    binding<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
                    resource<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">BindingResource</span><span class="token punctuation">::</span><span class="token class-name">TextureView</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>src<span class="token punctuation">.</span>view<span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">BindGroupEntry</span> <span class="token punctuation">{</span>
                    binding<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
                    resource<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">BindingResource</span><span class="token punctuation">::</span><span class="token class-name">TextureView</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>dst_view<span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">let</span> <span class="token keyword">mut</span> encoder <span class="token operator">=</span> device<span class="token punctuation">.</span><span class="token function">create_command_encoder</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token class-name">Default</span><span class="token punctuation">::</span><span class="token function">default</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> <span class="token keyword">mut</span> pass <span class="token operator">=</span> encoder<span class="token punctuation">.</span><span class="token function">begin_compute_pass</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">ComputePassDescriptor</span> <span class="token punctuation">{</span> label <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">let</span> num_workgroups <span class="token operator">=</span> <span class="token punctuation">(</span>dst_size <span class="token operator">+</span> <span class="token number">15</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">16</span><span class="token punctuation">;</span>
        pass<span class="token punctuation">.</span><span class="token function">set_pipeline</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">.</span>equirect_to_cubemap<span class="token punctuation">)</span><span class="token punctuation">;</span>
        pass<span class="token punctuation">.</span><span class="token function">set_bind_group</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>bind_group<span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        pass<span class="token punctuation">.</span><span class="token function">dispatch_workgroups</span><span class="token punctuation">(</span>num_workgroups<span class="token punctuation">,</span> num_workgroups<span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token function">drop</span><span class="token punctuation">(</span>pass<span class="token punctuation">)</span><span class="token punctuation">;</span>

        queue<span class="token punctuation">.</span><span class="token function">submit</span><span class="token punctuation">(</span><span class="token punctuation">[</span>encoder<span class="token punctuation">.</span><span class="token function">finish</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">Ok</span><span class="token punctuation">(</span>dst<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p><code>dispatch_workgroups</code> 호출은 GPU에게 워크그룹(workgroup)이라는 배치 단위로 코드를 실행하도록 지시합니다. 각 워크그룹에는 인보케이션(invocation)이라고 불리는 여러 작업자 스레드가 있어 코드를 병렬로 실행합니다. 워크그룹은 우리가 <code>dispatch_workgroups</code>에 전달하는 차원을 가진 3D 그리드로 구성됩니다.</p> <p>이 예제에서는 워크그룹 그리드를 16x16 청크로 나누고 z 차원에 레이어를 저장합니다.</p> <h2 id="컴퓨트-셰이더"><a href="#컴퓨트-셰이더" class="header-anchor">#</a> 컴퓨트 셰이더</h2> <p>이제 정거원통도법 텍스처를 큐브 텍스처로 변환하는 컴퓨트 셰이더를 작성해 보겠습니다. <code>equirectangular.wgsl</code>이라는 파일을 만드세요. 청크별로 나누어 설명하겠습니다.</p> <div class="language-wgsl extra-class"><pre class="language-wgsl"><code><span class="token keyword">const</span> <span class="token class-name">PI</span><span class="token punctuation">:</span> <span class="token builtin">f32</span> <span class="token operator">=</span> <span class="token decimal-float-literal number">3.1415926535897932384626433832795</span><span class="token punctuation">;</span>

<span class="token keyword">struct</span> <span class="token class-name">Face</span> <span class="token punctuation">{</span>
    forward<span class="token punctuation">:</span> <span class="token builtin">vec3</span><span class="token punctuation">&lt;</span><span class="token builtin">f32</span><span class="token punctuation">&gt;</span><span class="token punctuation">,</span>
    up<span class="token punctuation">:</span> <span class="token builtin">vec3</span><span class="token punctuation">&lt;</span><span class="token builtin">f32</span><span class="token punctuation">&gt;</span><span class="token punctuation">,</span>
    right<span class="token punctuation">:</span> <span class="token builtin">vec3</span><span class="token punctuation">&lt;</span><span class="token builtin">f32</span><span class="token punctuation">&gt;</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre></div><p>여기서 두 가지 사항이 있습니다:</p> <ol><li>WGSL에는 PI에 대한 내장 상수가 없으므로 직접 지정해야 합니다.</li> <li>큐브맵의 각 면에는 방향성이 있으므로 이를 저장해야 합니다.</li></ol> <div class="language-wgsl extra-class"><pre class="language-wgsl"><code><span class="token punctuation">@</span><span class="token attributes attr-name">group</span><span class="token punctuation">(</span><span class="token int-literal number">0</span><span class="token punctuation">)</span>
<span class="token punctuation">@</span><span class="token attributes attr-name">binding</span><span class="token punctuation">(</span><span class="token int-literal number">0</span><span class="token punctuation">)</span>
<span class="token keyword">var</span> src<span class="token punctuation">:</span> <span class="token builtin">texture_2d</span><span class="token punctuation">&lt;</span><span class="token builtin">f32</span><span class="token punctuation">&gt;</span><span class="token punctuation">;</span>

<span class="token punctuation">@</span><span class="token attributes attr-name">group</span><span class="token punctuation">(</span><span class="token int-literal number">0</span><span class="token punctuation">)</span>
<span class="token punctuation">@</span><span class="token attributes attr-name">binding</span><span class="token punctuation">(</span><span class="token int-literal number">1</span><span class="token punctuation">)</span>
<span class="token keyword">var</span> dst<span class="token punctuation">:</span> <span class="token builtin">texture_storage_2d_array</span><span class="token punctuation">&lt;</span>rgba32float<span class="token punctuation">,</span> write<span class="token punctuation">&gt;</span><span class="token punctuation">;</span>
</code></pre></div><p>여기에는 필요한 두 개의 바인딩만 있습니다. 정거원통도법 <code>src</code> 텍스처와 <code>dst</code> 큐브 텍스처입니다. <code>dst</code>에 대해 주목할 몇 가지 사항:</p> <ol><li><code>dst</code>는 큐브 텍스처이지만, 2D 텍스처 배열로 저장됩니다.</li> <li>여기서 사용하는 바인딩 유형은 스토리지 텍스처(storage texture)입니다. 정확히는 배열 스토리지 텍스처입니다. 이는 컴퓨트 셰이더에서만 사용할 수 있는 고유한 바인딩으로, 텍스처에 직접 쓸 수 있게 해줍니다.</li> <li>스토리지 텍스처 바인딩을 사용할 때는 텍스처의 포맷을 지정해야 합니다. 다른 포맷의 텍스처를 바인딩하려고 하면 wgpu가 패닉을 일으킵니다.</li></ol> <div class="language-wgsl extra-class"><pre class="language-wgsl"><code><span class="token punctuation">@</span><span class="token attributes attr-name">compute</span>
<span class="token punctuation">@</span><span class="token attributes attr-name">workgroup_size</span><span class="token punctuation">(</span><span class="token int-literal number">16</span><span class="token punctuation">,</span> <span class="token int-literal number">16</span><span class="token punctuation">,</span> <span class="token int-literal number">1</span><span class="token punctuation">)</span>
<span class="token keyword">fn</span> <span class="token functions function">compute_equirect_to_cubemap</span><span class="token punctuation">(</span>
    <span class="token punctuation">@</span><span class="token builtin-attribute"><span class="token attribute attr-name">builtin</span><span class="token punctuation">(</span><span class="token built-in-values attr-value">global_invocation_id</span><span class="token punctuation">)</span></span>
    gid<span class="token punctuation">:</span> <span class="token builtin">vec3</span><span class="token punctuation">&lt;</span><span class="token builtin">u32</span><span class="token punctuation">&gt;</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 텍스처 크기가 32로 나누어 떨어지지 않으면,</span>
    <span class="token comment">// 존재하지 않는 픽셀에 쓰려고 시도하지 않도록</span>
    <span class="token comment">// 해야 합니다.</span>
    <span class="token keyword">if</span> gid<span class="token punctuation">.</span>x <span class="token operator">&gt;=</span> <span class="token builtin">u32</span><span class="token punctuation">(</span><span class="token builtin">textureDimensions</span><span class="token punctuation">(</span>dst<span class="token punctuation">)</span><span class="token punctuation">.</span>x<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">var</span> <span class="token class-name">FACES</span><span class="token punctuation">:</span> <span class="token builtin">array</span><span class="token punctuation">&lt;</span><span class="token class-name">Face</span><span class="token punctuation">,</span> <span class="token int-literal number">6</span><span class="token punctuation">&gt;</span> <span class="token operator">=</span> <span class="token builtin">array</span><span class="token punctuation">(</span>
        <span class="token comment">// FACES +X</span>
        <span class="token function-calls function">Face</span><span class="token punctuation">(</span>
            <span class="token builtin">vec3</span><span class="token punctuation">(</span><span class="token decimal-float-literal number">1.0</span><span class="token punctuation">,</span> <span class="token decimal-float-literal number">0.0</span><span class="token punctuation">,</span> <span class="token decimal-float-literal number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment">// forward</span>
            <span class="token builtin">vec3</span><span class="token punctuation">(</span><span class="token decimal-float-literal number">0.0</span><span class="token punctuation">,</span> <span class="token decimal-float-literal number">1.0</span><span class="token punctuation">,</span> <span class="token decimal-float-literal number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment">// up</span>
            <span class="token builtin">vec3</span><span class="token punctuation">(</span><span class="token decimal-float-literal number">0.0</span><span class="token punctuation">,</span> <span class="token decimal-float-literal number">0.0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token decimal-float-literal number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// right</span>
        <span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token comment">// FACES -X</span>
        <span class="token class-name">Face</span> <span class="token punctuation">(</span>
            <span class="token builtin">vec3</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token decimal-float-literal number">1.0</span><span class="token punctuation">,</span> <span class="token decimal-float-literal number">0.0</span><span class="token punctuation">,</span> <span class="token decimal-float-literal number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token builtin">vec3</span><span class="token punctuation">(</span><span class="token decimal-float-literal number">0.0</span><span class="token punctuation">,</span> <span class="token decimal-float-literal number">1.0</span><span class="token punctuation">,</span> <span class="token decimal-float-literal number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token builtin">vec3</span><span class="token punctuation">(</span><span class="token decimal-float-literal number">0.0</span><span class="token punctuation">,</span> <span class="token decimal-float-literal number">0.0</span><span class="token punctuation">,</span> <span class="token decimal-float-literal number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token comment">// FACES +Y</span>
        <span class="token class-name">Face</span> <span class="token punctuation">(</span>
            <span class="token builtin">vec3</span><span class="token punctuation">(</span><span class="token decimal-float-literal number">0.0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token decimal-float-literal number">1.0</span><span class="token punctuation">,</span> <span class="token decimal-float-literal number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token builtin">vec3</span><span class="token punctuation">(</span><span class="token decimal-float-literal number">0.0</span><span class="token punctuation">,</span> <span class="token decimal-float-literal number">0.0</span><span class="token punctuation">,</span> <span class="token decimal-float-literal number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token builtin">vec3</span><span class="token punctuation">(</span><span class="token decimal-float-literal number">1.0</span><span class="token punctuation">,</span> <span class="token decimal-float-literal number">0.0</span><span class="token punctuation">,</span> <span class="token decimal-float-literal number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token comment">// FACES -Y</span>
        <span class="token class-name">Face</span> <span class="token punctuation">(</span>
            <span class="token builtin">vec3</span><span class="token punctuation">(</span><span class="token decimal-float-literal number">0.0</span><span class="token punctuation">,</span> <span class="token decimal-float-literal number">1.0</span><span class="token punctuation">,</span> <span class="token decimal-float-literal number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token builtin">vec3</span><span class="token punctuation">(</span><span class="token decimal-float-literal number">0.0</span><span class="token punctuation">,</span> <span class="token decimal-float-literal number">0.0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token decimal-float-literal number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token builtin">vec3</span><span class="token punctuation">(</span><span class="token decimal-float-literal number">1.0</span><span class="token punctuation">,</span> <span class="token decimal-float-literal number">0.0</span><span class="token punctuation">,</span> <span class="token decimal-float-literal number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token comment">// FACES +Z</span>
        <span class="token class-name">Face</span> <span class="token punctuation">(</span>
            <span class="token builtin">vec3</span><span class="token punctuation">(</span><span class="token decimal-float-literal number">0.0</span><span class="token punctuation">,</span> <span class="token decimal-float-literal number">0.0</span><span class="token punctuation">,</span> <span class="token decimal-float-literal number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token builtin">vec3</span><span class="token punctuation">(</span><span class="token decimal-float-literal number">0.0</span><span class="token punctuation">,</span> <span class="token decimal-float-literal number">1.0</span><span class="token punctuation">,</span> <span class="token decimal-float-literal number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token builtin">vec3</span><span class="token punctuation">(</span><span class="token decimal-float-literal number">1.0</span><span class="token punctuation">,</span> <span class="token decimal-float-literal number">0.0</span><span class="token punctuation">,</span> <span class="token decimal-float-literal number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token comment">// FACES -Z</span>
        <span class="token class-name">Face</span> <span class="token punctuation">(</span>
            <span class="token builtin">vec3</span><span class="token punctuation">(</span><span class="token decimal-float-literal number">0.0</span><span class="token punctuation">,</span> <span class="token decimal-float-literal number">0.0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token decimal-float-literal number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token builtin">vec3</span><span class="token punctuation">(</span><span class="token decimal-float-literal number">0.0</span><span class="token punctuation">,</span> <span class="token decimal-float-literal number">1.0</span><span class="token punctuation">,</span> <span class="token decimal-float-literal number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token builtin">vec3</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token decimal-float-literal number">1.0</span><span class="token punctuation">,</span> <span class="token decimal-float-literal number">0.0</span><span class="token punctuation">,</span> <span class="token decimal-float-literal number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 큐브맵 면에 상대적인 텍스처 좌표 얻기</span>
    <span class="token keyword">let</span> dst_dimensions <span class="token operator">=</span> <span class="token builtin">vec2</span><span class="token punctuation">&lt;</span><span class="token builtin">f32</span><span class="token punctuation">&gt;</span><span class="token punctuation">(</span><span class="token builtin">textureDimensions</span><span class="token punctuation">(</span>dst<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> cube_uv <span class="token operator">=</span> <span class="token builtin">vec2</span><span class="token punctuation">&lt;</span><span class="token builtin">f32</span><span class="token punctuation">&gt;</span><span class="token punctuation">(</span>gid<span class="token punctuation">.</span>xy<span class="token punctuation">)</span> <span class="token operator">/</span> dst_dimensions <span class="token operator">*</span> <span class="token decimal-float-literal number">2.0</span> <span class="token operator">-</span> <span class="token decimal-float-literal number">1.0</span><span class="token punctuation">;</span>

    <span class="token comment">// cube_uv로부터 구면 좌표 얻기</span>
    <span class="token keyword">let</span> face <span class="token operator">=</span> <span class="token class-name">FACES</span><span class="token punctuation">[</span>gid<span class="token punctuation">.</span>z<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> spherical <span class="token operator">=</span> <span class="token builtin">normalize</span><span class="token punctuation">(</span>face<span class="token punctuation">.</span>forward <span class="token operator">+</span> face<span class="token punctuation">.</span>right <span class="token operator">*</span> cube_uv<span class="token punctuation">.</span>x <span class="token operator">+</span> face<span class="token punctuation">.</span>up <span class="token operator">*</span> cube_uv<span class="token punctuation">.</span>y<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 정거원통도법 텍스처 상의 좌표 얻기</span>
    <span class="token keyword">let</span> inv_atan <span class="token operator">=</span> <span class="token builtin">vec2</span><span class="token punctuation">(</span><span class="token decimal-float-literal number">0.1591</span><span class="token punctuation">,</span> <span class="token decimal-float-literal number">0.3183</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> eq_uv <span class="token operator">=</span> <span class="token builtin">vec2</span><span class="token punctuation">(</span><span class="token builtin">atan2</span><span class="token punctuation">(</span>spherical<span class="token punctuation">.</span>z<span class="token punctuation">,</span> spherical<span class="token punctuation">.</span>x<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">asin</span><span class="token punctuation">(</span>spherical<span class="token punctuation">.</span>y<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">*</span> inv_atan <span class="token operator">+</span> <span class="token decimal-float-literal number">0.5</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> eq_pixel <span class="token operator">=</span> <span class="token builtin">vec2</span><span class="token punctuation">&lt;</span><span class="token builtin">i32</span><span class="token punctuation">&gt;</span><span class="token punctuation">(</span>eq_uv <span class="token operator">*</span> <span class="token builtin">vec2</span><span class="token punctuation">&lt;</span><span class="token builtin">f32</span><span class="token punctuation">&gt;</span><span class="token punctuation">(</span><span class="token builtin">textureDimensions</span><span class="token punctuation">(</span>src<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// textureSample()은 컴퓨트 셰이더에서 허용되지 않으므로 textureLoad()를 사용합니다.</span>
    <span class="token keyword">var</span> sample <span class="token operator">=</span> <span class="token builtin">textureLoad</span><span class="token punctuation">(</span>src<span class="token punctuation">,</span> eq_pixel<span class="token punctuation">,</span> <span class="token int-literal number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token builtin">textureStore</span><span class="token punctuation">(</span>dst<span class="token punctuation">,</span> gid<span class="token punctuation">.</span>xy<span class="token punctuation">,</span> gid<span class="token punctuation">.</span>z<span class="token punctuation">,</span> sample<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>이전 코드에 주석을 달았지만, 주석에 잘 맞지 않는 몇 가지 사항을 짚고 넘어가고 싶습니다.</p> <p><code>workgroup_size</code> 데코레이터는 워크그룹의 로컬 인보케이션 그리드 차원을 알려줍니다. 텍스처의 모든 픽셀에 대해 하나의 워크그룹을 디스패치하므로, 각 워크그룹은 16x16x1 그리드가 됩니다. 이는 각 워크그룹이 256개의 스레드를 가질 수 있다는 의미입니다.</p> <div class="warn"><p>WebGPU의 경우, 각 워크그룹은 최대 256개의 스레드(인보케이션이라고도 함)만 가질 수 있습니다.</p></div> <p>이제 <code>new()</code> 함수에서 환경 맵을 로드할 수 있습니다:</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">let</span> hdr_loader <span class="token operator">=</span> <span class="token namespace">resources<span class="token punctuation">::</span></span><span class="token class-name">HdrLoader</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>device<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> sky_bytes <span class="token operator">=</span> <span class="token namespace">resources<span class="token punctuation">::</span></span><span class="token function">load_binary</span><span class="token punctuation">(</span><span class="token string">&quot;pure-sky.hdr&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">await</span><span class="token operator">?</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> sky_texture <span class="token operator">=</span> hdr_loader<span class="token punctuation">.</span><span class="token function">from_equirectangular_bytes</span><span class="token punctuation">(</span>
    <span class="token operator">&amp;</span>device<span class="token punctuation">,</span>
    <span class="token operator">&amp;</span>queue<span class="token punctuation">,</span>
    <span class="token operator">&amp;</span>sky_bytes<span class="token punctuation">,</span>
    <span class="token number">1080</span><span class="token punctuation">,</span>
    <span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token string">&quot;Sky Texture&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="스카이박스-skybox"><a href="#스카이박스-skybox" class="header-anchor">#</a> 스카이박스 (Skybox)</h2> <p>이제 렌더링할 환경 맵이 있으니, 이를 사용하여 스카이박스를 만들어 봅시다. 스카이박스를 렌더링하는 방법은 여러 가지가 있습니다. 표준적인 방법은 큐브를 렌더링하고 그 위에 환경 맵을 매핑하는 것입니다. 이 방법도 작동하지만, 큐브의 면이 만나는 모서리와 가장자리에서 일부 아티팩트가 발생할 수 있습니다.</p> <p>대신, 우리는 전체 화면에 렌더링하고, 각 픽셀에서 뷰 방향을 계산하여 텍스처를 샘플링할 것입니다. 먼저, 렌더링에 사용할 수 있도록 환경 맵에 대한 바인드그룹을 만들어야 합니다. <code>new()</code>에 다음을 추가하세요:</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">let</span> environment_layout <span class="token operator">=</span>
    device<span class="token punctuation">.</span><span class="token function">create_bind_group_layout</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">BindGroupLayoutDescriptor</span> <span class="token punctuation">{</span>
        label<span class="token punctuation">:</span> <span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token string">&quot;environment_layout&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        entries<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token punctuation">[</span>
            <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">BindGroupLayoutEntry</span> <span class="token punctuation">{</span>
                binding<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
                visibility<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">ShaderStages</span><span class="token punctuation">::</span><span class="token constant">FRAGMENT</span><span class="token punctuation">,</span>
                ty<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">BindingType</span><span class="token punctuation">::</span><span class="token class-name">Texture</span> <span class="token punctuation">{</span>
                    sample_type<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">TextureSampleType</span><span class="token punctuation">::</span><span class="token class-name">Float</span> <span class="token punctuation">{</span> filterable<span class="token punctuation">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
                    view_dimension<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">TextureViewDimension</span><span class="token punctuation">::</span><span class="token class-name">Cube</span><span class="token punctuation">,</span>
                    multisampled<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
                count<span class="token punctuation">:</span> <span class="token class-name">None</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">BindGroupLayoutEntry</span> <span class="token punctuation">{</span>
                binding<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
                visibility<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">ShaderStages</span><span class="token punctuation">::</span><span class="token constant">FRAGMENT</span><span class="token punctuation">,</span>
                ty<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">BindingType</span><span class="token punctuation">::</span><span class="token class-name">Sampler</span><span class="token punctuation">(</span><span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">SamplerBindingType</span><span class="token punctuation">::</span><span class="token class-name">NonFiltering</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                count<span class="token punctuation">:</span> <span class="token class-name">None</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">let</span> environment_bind_group <span class="token operator">=</span> device<span class="token punctuation">.</span><span class="token function">create_bind_group</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">BindGroupDescriptor</span> <span class="token punctuation">{</span>
    label<span class="token punctuation">:</span> <span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token string">&quot;environment_bind_group&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    layout<span class="token punctuation">:</span> <span class="token operator">&amp;</span>environment_layout<span class="token punctuation">,</span>
    entries<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token punctuation">[</span>
        <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">BindGroupEntry</span> <span class="token punctuation">{</span>
            binding<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
            resource<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">BindingResource</span><span class="token punctuation">::</span><span class="token class-name">TextureView</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>sky_texture<span class="token punctuation">.</span><span class="token function">view</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">BindGroupEntry</span> <span class="token punctuation">{</span>
            binding<span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
            resource<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">BindingResource</span><span class="token punctuation">::</span><span class="token class-name">Sampler</span><span class="token punctuation">(</span>sky_texture<span class="token punctuation">.</span><span class="token function">sampler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>이제 바인드그룹이 있으니, 스카이박스를 렌더링할 렌더 파이프라인이 필요합니다.</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token comment">// NEW!</span>
<span class="token keyword">let</span> sky_pipeline <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> layout <span class="token operator">=</span> device<span class="token punctuation">.</span><span class="token function">create_pipeline_layout</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">PipelineLayoutDescriptor</span> <span class="token punctuation">{</span>
        label<span class="token punctuation">:</span> <span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token string">&quot;Sky Pipeline Layout&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        bind_group_layouts<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token punctuation">[</span><span class="token operator">&amp;</span>camera_bind_group_layout<span class="token punctuation">,</span> <span class="token operator">&amp;</span>environment_layout<span class="token punctuation">]</span><span class="token punctuation">,</span>
        push_constant_ranges<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> shader <span class="token operator">=</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token macro property">include_wgsl!</span><span class="token punctuation">(</span><span class="token string">&quot;sky.wgsl&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">create_render_pipeline</span><span class="token punctuation">(</span>
        <span class="token operator">&amp;</span>device<span class="token punctuation">,</span>
        <span class="token operator">&amp;</span>layout<span class="token punctuation">,</span>
        hdr<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token namespace">texture<span class="token punctuation">::</span></span><span class="token class-name">Texture</span><span class="token punctuation">::</span><span class="token constant">DEPTH_FORMAT</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token operator">&amp;</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">PrimitiveTopology</span><span class="token punctuation">::</span><span class="token class-name">TriangleList</span><span class="token punctuation">,</span>
        shader<span class="token punctuation">,</span>
    <span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>여기서 주목할 점이 하나 있습니다. <code>create_render_pipeline()</code>에 프리미티브 포맷을 추가했습니다. 또한, 깊이 비교 함수를 <code>CompareFunction::LessEqual</code>로 변경했습니다 (왜 그런지는 스카이 셰이더를 다룰 때 논의할 것입니다). 해당 변경 사항은 다음과 같습니다:</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">fn</span> <span class="token function-definition function">create_render_pipeline</span><span class="token punctuation">(</span>
    device<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">Device</span><span class="token punctuation">,</span>
    layout<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">PipelineLayout</span><span class="token punctuation">,</span>
    color_format<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">TextureFormat</span><span class="token punctuation">,</span>
    depth_format<span class="token punctuation">:</span> <span class="token class-name">Option</span><span class="token operator">&lt;</span><span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">TextureFormat</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
    vertex_layouts<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token punctuation">[</span><span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">VertexBufferLayout</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    topology<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">PrimitiveTopology</span><span class="token punctuation">,</span> <span class="token comment">// NEW!</span>
    shader<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">ShaderModuleDescriptor</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">RenderPipeline</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> shader <span class="token operator">=</span> device<span class="token punctuation">.</span><span class="token function">create_shader_module</span><span class="token punctuation">(</span>shader<span class="token punctuation">)</span><span class="token punctuation">;</span>

    device<span class="token punctuation">.</span><span class="token function">create_render_pipeline</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">RenderPipelineDescriptor</span> <span class="token punctuation">{</span>
        <span class="token comment">// ...</span>
        primitive<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">PrimitiveState</span> <span class="token punctuation">{</span>
            topology<span class="token punctuation">,</span> <span class="token comment">// NEW!</span>
            <span class="token comment">// ...</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        depth_stencil<span class="token punctuation">:</span> depth_format<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>format<span class="token closure-punctuation punctuation">|</span></span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">DepthStencilState</span> <span class="token punctuation">{</span>
            format<span class="token punctuation">,</span>
            depth_write_enabled<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
            depth_compare<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">CompareFunction</span><span class="token punctuation">::</span><span class="token class-name">LessEqual</span><span class="token punctuation">,</span> <span class="token comment">// UDPATED!</span>
            stencil<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">StencilState</span><span class="token punctuation">::</span><span class="token function">default</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            bias<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">DepthBiasState</span><span class="token punctuation">::</span><span class="token function">default</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token comment">// ...</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>새로운 바인드그룹과 파이프라인을 <code>State</code>에 추가하는 것을 잊지 마세요.</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">pub</span> <span class="token keyword">struct</span> <span class="token type-definition class-name">State</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
    <span class="token comment">// NEW!</span>
    hdr<span class="token punctuation">:</span> <span class="token namespace">hdr<span class="token punctuation">::</span></span><span class="token class-name">HdrPipeline</span><span class="token punctuation">,</span>
    environment_bind_group<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">BindGroup</span><span class="token punctuation">,</span>
    sky_pipeline<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">RenderPipeline</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token comment">// ...</span>
<span class="token keyword">impl</span> <span class="token class-name">State</span> <span class="token punctuation">{</span>
    <span class="token keyword">async</span> <span class="token keyword">fn</span> <span class="token function-definition function">new</span><span class="token punctuation">(</span>window<span class="token punctuation">:</span> <span class="token class-name">Arc</span><span class="token operator">&lt;</span><span class="token class-name">Window</span><span class="token operator">&gt;</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token namespace">anyhow<span class="token punctuation">::</span></span><span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token class-name">State</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
        <span class="token comment">// ...</span>
        <span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token keyword">Self</span> <span class="token punctuation">{</span>
            <span class="token comment">// ...</span>
            <span class="token comment">// NEW!</span>
            hdr<span class="token punctuation">,</span>
            environment_bind_group<span class="token punctuation">,</span>
            sky_pipeline<span class="token punctuation">,</span>
            debug<span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>이제 <code>sky.wgsl</code>을 다루어 봅시다.</p> <div class="language-wgsl extra-class"><pre class="language-wgsl"><code><span class="token keyword">struct</span> <span class="token class-name">Camera</span> <span class="token punctuation">{</span>
    view_pos<span class="token punctuation">:</span> <span class="token builtin">vec4</span><span class="token punctuation">&lt;</span><span class="token builtin">f32</span><span class="token punctuation">&gt;</span><span class="token punctuation">,</span>
    view<span class="token punctuation">:</span> <span class="token builtin">mat4x4</span><span class="token punctuation">&lt;</span><span class="token builtin">f32</span><span class="token punctuation">&gt;</span><span class="token punctuation">,</span>
    view_proj<span class="token punctuation">:</span> <span class="token builtin">mat4x4</span><span class="token punctuation">&lt;</span><span class="token builtin">f32</span><span class="token punctuation">&gt;</span><span class="token punctuation">,</span>
    inv_proj<span class="token punctuation">:</span> <span class="token builtin">mat4x4</span><span class="token punctuation">&lt;</span><span class="token builtin">f32</span><span class="token punctuation">&gt;</span><span class="token punctuation">,</span>
    inv_view<span class="token punctuation">:</span> <span class="token builtin">mat4x4</span><span class="token punctuation">&lt;</span><span class="token builtin">f32</span><span class="token punctuation">&gt;</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
<span class="token punctuation">@</span><span class="token attributes attr-name">group</span><span class="token punctuation">(</span><span class="token int-literal number">0</span><span class="token punctuation">)</span> <span class="token punctuation">@</span><span class="token attributes attr-name">binding</span><span class="token punctuation">(</span><span class="token int-literal number">0</span><span class="token punctuation">)</span>
<span class="token keyword">var</span><span class="token punctuation">&lt;</span><span class="token keyword">uniform</span><span class="token punctuation">&gt;</span> camera<span class="token punctuation">:</span> <span class="token class-name">Camera</span><span class="token punctuation">;</span>

<span class="token punctuation">@</span><span class="token attributes attr-name">group</span><span class="token punctuation">(</span><span class="token int-literal number">1</span><span class="token punctuation">)</span>
<span class="token punctuation">@</span><span class="token attributes attr-name">binding</span><span class="token punctuation">(</span><span class="token int-literal number">0</span><span class="token punctuation">)</span>
<span class="token keyword">var</span> env_map<span class="token punctuation">:</span> <span class="token builtin">texture_cube</span><span class="token punctuation">&lt;</span><span class="token builtin">f32</span><span class="token punctuation">&gt;</span><span class="token punctuation">;</span>
<span class="token punctuation">@</span><span class="token attributes attr-name">group</span><span class="token punctuation">(</span><span class="token int-literal number">1</span><span class="token punctuation">)</span>
<span class="token punctuation">@</span><span class="token attributes attr-name">binding</span><span class="token punctuation">(</span><span class="token int-literal number">1</span><span class="token punctuation">)</span>
<span class="token keyword">var</span> env_sampler<span class="token punctuation">:</span> <span class="token builtin">sampler</span><span class="token punctuation">;</span>

<span class="token keyword">struct</span> <span class="token class-name">VertexOutput</span> <span class="token punctuation">{</span>
    <span class="token punctuation">@</span><span class="token builtin-attribute"><span class="token attribute attr-name">builtin</span><span class="token punctuation">(</span><span class="token built-in-values attr-value">position</span><span class="token punctuation">)</span></span> frag_position<span class="token punctuation">:</span> <span class="token builtin">vec4</span><span class="token punctuation">&lt;</span><span class="token builtin">f32</span><span class="token punctuation">&gt;</span><span class="token punctuation">,</span>
    <span class="token punctuation">@</span><span class="token attributes attr-name">location</span><span class="token punctuation">(</span><span class="token int-literal number">0</span><span class="token punctuation">)</span> clip_position<span class="token punctuation">:</span> <span class="token builtin">vec4</span><span class="token punctuation">&lt;</span><span class="token builtin">f32</span><span class="token punctuation">&gt;</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token punctuation">@</span><span class="token attributes attr-name">vertex</span>
<span class="token keyword">fn</span> <span class="token functions function">vs_main</span><span class="token punctuation">(</span>
    <span class="token punctuation">@</span><span class="token builtin-attribute"><span class="token attribute attr-name">builtin</span><span class="token punctuation">(</span><span class="token built-in-values attr-value">vertex_index</span><span class="token punctuation">)</span></span> id<span class="token punctuation">:</span> <span class="token builtin">u32</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token class-name">VertexOutput</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> uv <span class="token operator">=</span> <span class="token builtin">vec2</span><span class="token punctuation">&lt;</span><span class="token builtin">f32</span><span class="token punctuation">&gt;</span><span class="token punctuation">(</span><span class="token builtin">vec2</span><span class="token punctuation">&lt;</span><span class="token builtin">u32</span><span class="token punctuation">&gt;</span><span class="token punctuation">(</span>
        id <span class="token operator">&amp;</span> <span class="token int-literal number">1u</span><span class="token punctuation">,</span>
        <span class="token punctuation">(</span>id <span class="token operator">&gt;&gt;</span> <span class="token int-literal number">1u</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token int-literal number">1u</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> out<span class="token punctuation">:</span> <span class="token class-name">VertexOutput</span><span class="token punctuation">;</span>
    <span class="token comment">// out.clip_position = vec4(uv * vec2(4.0, -4.0) + vec2(-1.0, 1.0), 0.0, 1.0);</span>
    out<span class="token punctuation">.</span>clip_position <span class="token operator">=</span> <span class="token builtin">vec4</span><span class="token punctuation">(</span>uv <span class="token operator">*</span> <span class="token decimal-float-literal number">4.0</span> <span class="token operator">-</span> <span class="token decimal-float-literal number">1.0</span><span class="token punctuation">,</span> <span class="token decimal-float-literal number">1.0</span><span class="token punctuation">,</span> <span class="token decimal-float-literal number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    out<span class="token punctuation">.</span>frag_position <span class="token operator">=</span> <span class="token builtin">vec4</span><span class="token punctuation">(</span>uv <span class="token operator">*</span> <span class="token decimal-float-literal number">4.0</span> <span class="token operator">-</span> <span class="token decimal-float-literal number">1.0</span><span class="token punctuation">,</span> <span class="token decimal-float-literal number">1.0</span><span class="token punctuation">,</span> <span class="token decimal-float-literal number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> out<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token punctuation">@</span><span class="token attributes attr-name">fragment</span>
<span class="token keyword">fn</span> <span class="token functions function">fs_main</span><span class="token punctuation">(</span>in<span class="token punctuation">:</span> <span class="token class-name">VertexOutput</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">@</span><span class="token attributes attr-name">location</span><span class="token punctuation">(</span><span class="token int-literal number">0</span><span class="token punctuation">)</span> <span class="token builtin">vec4</span><span class="token punctuation">&lt;</span><span class="token builtin">f32</span><span class="token punctuation">&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> view_pos_homogeneous <span class="token operator">=</span> camera<span class="token punctuation">.</span>inv_proj <span class="token operator">*</span> in<span class="token punctuation">.</span>clip_position<span class="token punctuation">;</span>
    <span class="token keyword">let</span> view_ray_direction <span class="token operator">=</span> view_pos_homogeneous<span class="token punctuation">.</span>xyz <span class="token operator">/</span> view_pos_homogeneous<span class="token punctuation">.</span>w<span class="token punctuation">;</span>
    <span class="token keyword">var</span> ray_direction <span class="token operator">=</span> <span class="token builtin">normalize</span><span class="token punctuation">(</span><span class="token punctuation">(</span>camera<span class="token punctuation">.</span>inv_view <span class="token operator">*</span> <span class="token builtin">vec4</span><span class="token punctuation">(</span>view_ray_direction<span class="token punctuation">,</span> <span class="token decimal-float-literal number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>xyz<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> sample <span class="token operator">=</span> <span class="token builtin">textureSample</span><span class="token punctuation">(</span>env_map<span class="token punctuation">,</span> env_sampler<span class="token punctuation">,</span> ray_direction<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> sample<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>이것을 분석해 봅시다:</p> <ol><li>화면 크기의 두 배인 삼각형을 만듭니다.</li> <li>프래그먼트 셰이더에서 클립 위치로부터 뷰 방향을 얻습니다. 역 투영 행렬을 사용하여 클립 좌표를 뷰 방향으로 변환합니다. 그런 다음, 역 뷰 행렬을 사용하여 방향을 월드 공간으로 변환합니다. 스카이 박스를 올바르게 샘플링하려면 월드 공간이 필요하기 때문입니다.</li> <li>그런 다음 뷰 방향으로 스카이 텍스처를 샘플링합니다.</li></ol> <p>이것이 작동하려면 카메라 유니폼을 약간 변경해야 합니다. <code>CameraUniform</code> 구조체에 역 뷰 행렬과 역 투영 행렬을 추가해야 합니다.</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token attribute attr-name">#[repr(C)]</span>
<span class="token attribute attr-name">#[derive(Copy, Clone, bytemuck::Pod, bytemuck::Zeroable)]</span>
<span class="token keyword">struct</span> <span class="token type-definition class-name">CameraUniform</span> <span class="token punctuation">{</span>
    view_position<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token keyword">f32</span><span class="token punctuation">;</span> <span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    view<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token keyword">f32</span><span class="token punctuation">;</span> <span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">// NEW!</span>
    view_proj<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token keyword">f32</span><span class="token punctuation">;</span> <span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    inv_proj<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token keyword">f32</span><span class="token punctuation">;</span> <span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">// NEW!</span>
    inv_view<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token keyword">f32</span><span class="token punctuation">;</span> <span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">// NEW!</span>
<span class="token punctuation">}</span>

<span class="token keyword">impl</span> <span class="token class-name">CameraUniform</span> <span class="token punctuation">{</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token keyword">Self</span> <span class="token punctuation">{</span>
        <span class="token keyword">Self</span> <span class="token punctuation">{</span>
            view_position<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">0.0</span><span class="token punctuation">;</span> <span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            view<span class="token punctuation">:</span> <span class="token namespace">cgmath<span class="token punctuation">::</span></span><span class="token class-name">Matrix4</span><span class="token punctuation">::</span><span class="token function">identity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">into</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            view_proj<span class="token punctuation">:</span> <span class="token namespace">cgmath<span class="token punctuation">::</span></span><span class="token class-name">Matrix4</span><span class="token punctuation">::</span><span class="token function">identity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">into</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            inv_proj<span class="token punctuation">:</span> <span class="token namespace">cgmath<span class="token punctuation">::</span></span><span class="token class-name">Matrix4</span><span class="token punctuation">::</span><span class="token function">identity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">into</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// NEW!</span>
            inv_view<span class="token punctuation">:</span> <span class="token namespace">cgmath<span class="token punctuation">::</span></span><span class="token class-name">Matrix4</span><span class="token punctuation">::</span><span class="token function">identity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">into</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// NEW!</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// UPDATED!</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">update_view_proj</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">,</span> camera<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token namespace">camera<span class="token punctuation">::</span></span><span class="token class-name">Camera</span><span class="token punctuation">,</span> projection<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token namespace">camera<span class="token punctuation">::</span></span><span class="token class-name">Projection</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>view_position <span class="token operator">=</span> camera<span class="token punctuation">.</span>position<span class="token punctuation">.</span><span class="token function">to_homogeneous</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">into</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> proj <span class="token operator">=</span> projection<span class="token punctuation">.</span><span class="token function">calc_matrix</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> view <span class="token operator">=</span> camera<span class="token punctuation">.</span><span class="token function">calc_matrix</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">let</span> view_proj <span class="token operator">=</span> proj <span class="token operator">*</span> view<span class="token punctuation">;</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>view <span class="token operator">=</span> view<span class="token punctuation">.</span><span class="token function">into</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>view_proj <span class="token operator">=</span> view_proj<span class="token punctuation">.</span><span class="token function">into</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>inv_proj <span class="token operator">=</span> proj<span class="token punctuation">.</span><span class="token function">invert</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">into</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>inv_view <span class="token operator">=</span> view<span class="token punctuation">.</span><span class="token function">transpose</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">into</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p><code>shader.wgsl</code>과 <code>light.wgsl</code>에서 <code>Camera</code> 정의를 변경하는 것을 잊지 마세요. 참고로, 다음과 같이 생겼습니다:</p> <div class="language-wgsl extra-class"><pre class="language-wgsl"><code><span class="token keyword">struct</span> <span class="token class-name">Camera</span> <span class="token punctuation">{</span>
    view_pos<span class="token punctuation">:</span> <span class="token builtin">vec4</span><span class="token punctuation">&lt;</span><span class="token builtin">f32</span><span class="token punctuation">&gt;</span><span class="token punctuation">,</span>
    view<span class="token punctuation">:</span> <span class="token builtin">mat4x4</span><span class="token punctuation">&lt;</span><span class="token builtin">f32</span><span class="token punctuation">&gt;</span><span class="token punctuation">,</span>
    view_proj<span class="token punctuation">:</span> <span class="token builtin">mat4x4</span><span class="token punctuation">&lt;</span><span class="token builtin">f32</span><span class="token punctuation">&gt;</span><span class="token punctuation">,</span>
    inv_proj<span class="token punctuation">:</span> <span class="token builtin">mat4x4</span><span class="token punctuation">&lt;</span><span class="token builtin">f32</span><span class="token punctuation">&gt;</span><span class="token punctuation">,</span>
    inv_view<span class="token punctuation">:</span> <span class="token builtin">mat4x4</span><span class="token punctuation">&lt;</span><span class="token builtin">f32</span><span class="token punctuation">&gt;</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
<span class="token keyword">var</span><span class="token punctuation">&lt;</span><span class="token keyword">uniform</span><span class="token punctuation">&gt;</span> camera<span class="token punctuation">:</span> <span class="token class-name">Camera</span><span class="token punctuation">;</span>
</code></pre></div><div class="info"><p><code>OPENGL_TO_WGPU_MATRIX</code>를 제거한 것을 눈치채셨을 겁니다. 그 이유는 스카이박스의 투영을 망가뜨리고 있었기 때문입니다.</p> <p><img src="/learn-wgpu/assets/img/project-error.00a25de7.png" alt="projection error"></p> <p>기술적으로 필요하지 않았기 때문에 제거하는 것이 괜찮다고 생각했습니다.</p></div> <h2 id="반사-reflections"><a href="#반사-reflections" class="header-anchor">#</a> 반사 (Reflections)</h2> <p>이제 하늘이 생겼으니, 이를 조명에 사용하는 것을 시도해 볼 수 있습니다. 이것은 물리적으로 정확하지는 않을 것입니다(나중에 그것에 대해 알아볼 것입니다). 그럼에도 불구하고 환경 맵이 있으니 사용하는 것이 좋겠습니다.</p> <p>하지만 그렇게 하려면, 우리의 환경 맵이 월드 공간에 있기 때문에 셰이더를 탄젠트 공간 대신 월드 공간에서 조명을 수행하도록 변경해야 합니다. 많은 변경 사항이 있으므로 여기에 전체 셰이더를 게시하겠습니다:</p> <div class="language-wgsl extra-class"><pre class="language-wgsl"><code><span class="token comment">// Vertex shader</span>

<span class="token keyword">struct</span> <span class="token class-name">Camera</span> <span class="token punctuation">{</span>
    view_pos<span class="token punctuation">:</span> <span class="token builtin">vec4</span><span class="token punctuation">&lt;</span><span class="token builtin">f32</span><span class="token punctuation">&gt;</span><span class="token punctuation">,</span>
    view<span class="token punctuation">:</span> <span class="token builtin">mat4x4</span><span class="token punctuation">&lt;</span><span class="token builtin">f32</span><span class="token punctuation">&gt;</span><span class="token punctuation">,</span>
    view_proj<span class="token punctuation">:</span> <span class="token builtin">mat4x4</span><span class="token punctuation">&lt;</span><span class="token builtin">f32</span><span class="token punctuation">&gt;</span><span class="token punctuation">,</span>
    inv_proj<span class="token punctuation">:</span> <span class="token builtin">mat4x4</span><span class="token punctuation">&lt;</span><span class="token builtin">f32</span><span class="token punctuation">&gt;</span><span class="token punctuation">,</span>
    inv_view<span class="token punctuation">:</span> <span class="token builtin">mat4x4</span><span class="token punctuation">&lt;</span><span class="token builtin">f32</span><span class="token punctuation">&gt;</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
<span class="token punctuation">@</span><span class="token attributes attr-name">group</span><span class="token punctuation">(</span><span class="token int-literal number">0</span><span class="token punctuation">)</span> <span class="token punctuation">@</span><span class="token attributes attr-name">binding</span><span class="token punctuation">(</span><span class="token int-literal number">0</span><span class="token punctuation">)</span>
<span class="token keyword">var</span><span class="token punctuation">&lt;</span><span class="token keyword">uniform</span><span class="token punctuation">&gt;</span> camera<span class="token punctuation">:</span> <span class="token class-name">Camera</span><span class="token punctuation">;</span>

<span class="token keyword">struct</span> <span class="token class-name">Light</span> <span class="token punctuation">{</span>
    position<span class="token punctuation">:</span> <span class="token builtin">vec3</span><span class="token punctuation">&lt;</span><span class="token builtin">f32</span><span class="token punctuation">&gt;</span><span class="token punctuation">,</span>
    color<span class="token punctuation">:</span> <span class="token builtin">vec3</span><span class="token punctuation">&lt;</span><span class="token builtin">f32</span><span class="token punctuation">&gt;</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
<span class="token punctuation">@</span><span class="token attributes attr-name">group</span><span class="token punctuation">(</span><span class="token int-literal number">2</span><span class="token punctuation">)</span> <span class="token punctuation">@</span><span class="token attributes attr-name">binding</span><span class="token punctuation">(</span><span class="token int-literal number">0</span><span class="token punctuation">)</span>
<span class="token keyword">var</span><span class="token punctuation">&lt;</span><span class="token keyword">uniform</span><span class="token punctuation">&gt;</span> light<span class="token punctuation">:</span> <span class="token class-name">Light</span><span class="token punctuation">;</span>

<span class="token keyword">struct</span> <span class="token class-name">VertexInput</span> <span class="token punctuation">{</span>
    <span class="token punctuation">@</span><span class="token attributes attr-name">location</span><span class="token punctuation">(</span><span class="token int-literal number">0</span><span class="token punctuation">)</span> position<span class="token punctuation">:</span> <span class="token builtin">vec3</span><span class="token punctuation">&lt;</span><span class="token builtin">f32</span><span class="token punctuation">&gt;</span><span class="token punctuation">,</span>
    <span class="token punctuation">@</span><span class="token attributes attr-name">location</span><span class="token punctuation">(</span><span class="token int-literal number">1</span><span class="token punctuation">)</span> tex_coords<span class="token punctuation">:</span> <span class="token builtin">vec2</span><span class="token punctuation">&lt;</span><span class="token builtin">f32</span><span class="token punctuation">&gt;</span><span class="token punctuation">,</span>
    <span class="token punctuation">@</span><span class="token attributes attr-name">location</span><span class="token punctuation">(</span><span class="token int-literal number">2</span><span class="token punctuation">)</span> normal<span class="token punctuation">:</span> <span class="token builtin">vec3</span><span class="token punctuation">&lt;</span><span class="token builtin">f32</span><span class="token punctuation">&gt;</span><span class="token punctuation">,</span>
    <span class="token punctuation">@</span><span class="token attributes attr-name">location</span><span class="token punctuation">(</span><span class="token int-literal number">3</span><span class="token punctuation">)</span> tangent<span class="token punctuation">:</span> <span class="token builtin">vec3</span><span class="token punctuation">&lt;</span><span class="token builtin">f32</span><span class="token punctuation">&gt;</span><span class="token punctuation">,</span>
    <span class="token punctuation">@</span><span class="token attributes attr-name">location</span><span class="token punctuation">(</span><span class="token int-literal number">4</span><span class="token punctuation">)</span> bitangent<span class="token punctuation">:</span> <span class="token builtin">vec3</span><span class="token punctuation">&lt;</span><span class="token builtin">f32</span><span class="token punctuation">&gt;</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
<span class="token keyword">struct</span> <span class="token class-name">InstanceInput</span> <span class="token punctuation">{</span>
    <span class="token punctuation">@</span><span class="token attributes attr-name">location</span><span class="token punctuation">(</span><span class="token int-literal number">5</span><span class="token punctuation">)</span> model_matrix_0<span class="token punctuation">:</span> <span class="token builtin">vec4</span><span class="token punctuation">&lt;</span><span class="token builtin">f32</span><span class="token punctuation">&gt;</span><span class="token punctuation">,</span>
    <span class="token punctuation">@</span><span class="token attributes attr-name">location</span><span class="token punctuation">(</span><span class="token int-literal number">6</span><span class="token punctuation">)</span> model_matrix_1<span class="token punctuation">:</span> <span class="token builtin">vec4</span><span class="token punctuation">&lt;</span><span class="token builtin">f32</span><span class="token punctuation">&gt;</span><span class="token punctuation">,</span>
    <span class="token punctuation">@</span><span class="token attributes attr-name">location</span><span class="token punctuation">(</span><span class="token int-literal number">7</span><span class="token punctuation">)</span> model_matrix_2<span class="token punctuation">:</span> <span class="token builtin">vec4</span><span class="token punctuation">&lt;</span><span class="token builtin">f32</span><span class="token punctuation">&gt;</span><span class="token punctuation">,</span>
    <span class="token punctuation">@</span><span class="token attributes attr-name">location</span><span class="token punctuation">(</span><span class="token int-literal number">8</span><span class="token punctuation">)</span> model_matrix_3<span class="token punctuation">:</span> <span class="token builtin">vec4</span><span class="token punctuation">&lt;</span><span class="token builtin">f32</span><span class="token punctuation">&gt;</span><span class="token punctuation">,</span>
    <span class="token punctuation">@</span><span class="token attributes attr-name">location</span><span class="token punctuation">(</span><span class="token int-literal number">9</span><span class="token punctuation">)</span> normal_matrix_0<span class="token punctuation">:</span> <span class="token builtin">vec3</span><span class="token punctuation">&lt;</span><span class="token builtin">f32</span><span class="token punctuation">&gt;</span><span class="token punctuation">,</span>
    <span class="token punctuation">@</span><span class="token attributes attr-name">location</span><span class="token punctuation">(</span><span class="token int-literal number">10</span><span class="token punctuation">)</span> normal_matrix_1<span class="token punctuation">:</span> <span class="token builtin">vec3</span><span class="token punctuation">&lt;</span><span class="token builtin">f32</span><span class="token punctuation">&gt;</span><span class="token punctuation">,</span>
    <span class="token punctuation">@</span><span class="token attributes attr-name">location</span><span class="token punctuation">(</span><span class="token int-literal number">11</span><span class="token punctuation">)</span> normal_matrix_2<span class="token punctuation">:</span> <span class="token builtin">vec3</span><span class="token punctuation">&lt;</span><span class="token builtin">f32</span><span class="token punctuation">&gt;</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">struct</span> <span class="token class-name">VertexOutput</span> <span class="token punctuation">{</span>
    <span class="token punctuation">@</span><span class="token builtin-attribute"><span class="token attribute attr-name">builtin</span><span class="token punctuation">(</span><span class="token built-in-values attr-value">position</span><span class="token punctuation">)</span></span> clip_position<span class="token punctuation">:</span> <span class="token builtin">vec4</span><span class="token punctuation">&lt;</span><span class="token builtin">f32</span><span class="token punctuation">&gt;</span><span class="token punctuation">,</span>
    <span class="token punctuation">@</span><span class="token attributes attr-name">location</span><span class="token punctuation">(</span><span class="token int-literal number">0</span><span class="token punctuation">)</span> tex_coords<span class="token punctuation">:</span> <span class="token builtin">vec2</span><span class="token punctuation">&lt;</span><span class="token builtin">f32</span><span class="token punctuation">&gt;</span><span class="token punctuation">,</span>
    <span class="token comment">// Updated!</span>
    <span class="token punctuation">@</span><span class="token attributes attr-name">location</span><span class="token punctuation">(</span><span class="token int-literal number">1</span><span class="token punctuation">)</span> world_position<span class="token punctuation">:</span> <span class="token builtin">vec3</span><span class="token punctuation">&lt;</span><span class="token builtin">f32</span><span class="token punctuation">&gt;</span><span class="token punctuation">,</span>
    <span class="token punctuation">@</span><span class="token attributes attr-name">location</span><span class="token punctuation">(</span><span class="token int-literal number">2</span><span class="token punctuation">)</span> world_view_position<span class="token punctuation">:</span> <span class="token builtin">vec3</span><span class="token punctuation">&lt;</span><span class="token builtin">f32</span><span class="token punctuation">&gt;</span><span class="token punctuation">,</span>
    <span class="token punctuation">@</span><span class="token attributes attr-name">location</span><span class="token punctuation">(</span><span class="token int-literal number">3</span><span class="token punctuation">)</span> world_light_position<span class="token punctuation">:</span> <span class="token builtin">vec3</span><span class="token punctuation">&lt;</span><span class="token builtin">f32</span><span class="token punctuation">&gt;</span><span class="token punctuation">,</span>
    <span class="token punctuation">@</span><span class="token attributes attr-name">location</span><span class="token punctuation">(</span><span class="token int-literal number">4</span><span class="token punctuation">)</span> world_normal<span class="token punctuation">:</span> <span class="token builtin">vec3</span><span class="token punctuation">&lt;</span><span class="token builtin">f32</span><span class="token punctuation">&gt;</span><span class="token punctuation">,</span>
    <span class="token punctuation">@</span><span class="token attributes attr-name">location</span><span class="token punctuation">(</span><span class="token int-literal number">5</span><span class="token punctuation">)</span> world_tangent<span class="token punctuation">:</span> <span class="token builtin">vec3</span><span class="token punctuation">&lt;</span><span class="token builtin">f32</span><span class="token punctuation">&gt;</span><span class="token punctuation">,</span>
    <span class="token punctuation">@</span><span class="token attributes attr-name">location</span><span class="token punctuation">(</span><span class="token int-literal number">6</span><span class="token punctuation">)</span> world_bitangent<span class="token punctuation">:</span> <span class="token builtin">vec3</span><span class="token punctuation">&lt;</span><span class="token builtin">f32</span><span class="token punctuation">&gt;</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token punctuation">@</span><span class="token attributes attr-name">vertex</span>
<span class="token keyword">fn</span> <span class="token functions function">vs_main</span><span class="token punctuation">(</span>
    model<span class="token punctuation">:</span> <span class="token class-name">VertexInput</span><span class="token punctuation">,</span>
    instance<span class="token punctuation">:</span> <span class="token class-name">InstanceInput</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token class-name">VertexOutput</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> model_matrix <span class="token operator">=</span> <span class="token builtin">mat4x4</span><span class="token punctuation">&lt;</span><span class="token builtin">f32</span><span class="token punctuation">&gt;</span><span class="token punctuation">(</span>
        instance<span class="token punctuation">.</span>model_matrix_0<span class="token punctuation">,</span>
        instance<span class="token punctuation">.</span>model_matrix_1<span class="token punctuation">,</span>
        instance<span class="token punctuation">.</span>model_matrix_2<span class="token punctuation">,</span>
        instance<span class="token punctuation">.</span>model_matrix_3<span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> normal_matrix <span class="token operator">=</span> <span class="token builtin">mat3x3</span><span class="token punctuation">&lt;</span><span class="token builtin">f32</span><span class="token punctuation">&gt;</span><span class="token punctuation">(</span>
        instance<span class="token punctuation">.</span>normal_matrix_0<span class="token punctuation">,</span>
        instance<span class="token punctuation">.</span>normal_matrix_1<span class="token punctuation">,</span>
        instance<span class="token punctuation">.</span>normal_matrix_2<span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// UPDATED!</span>
    <span class="token keyword">let</span> world_position <span class="token operator">=</span> model_matrix <span class="token operator">*</span> <span class="token builtin">vec4</span><span class="token punctuation">&lt;</span><span class="token builtin">f32</span><span class="token punctuation">&gt;</span><span class="token punctuation">(</span>model<span class="token punctuation">.</span>position<span class="token punctuation">,</span> <span class="token decimal-float-literal number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">var</span> out<span class="token punctuation">:</span> <span class="token class-name">VertexOutput</span><span class="token punctuation">;</span>
    out<span class="token punctuation">.</span>clip_position <span class="token operator">=</span> camera<span class="token punctuation">.</span>view_proj <span class="token operator">*</span> world_position<span class="token punctuation">;</span>
    out<span class="token punctuation">.</span>tex_coords <span class="token operator">=</span> model<span class="token punctuation">.</span>tex_coords<span class="token punctuation">;</span>
    out<span class="token punctuation">.</span>world_normal <span class="token operator">=</span> <span class="token builtin">normalize</span><span class="token punctuation">(</span>normal_matrix <span class="token operator">*</span> model<span class="token punctuation">.</span>normal<span class="token punctuation">)</span><span class="token punctuation">;</span>
    out<span class="token punctuation">.</span>world_tangent <span class="token operator">=</span> <span class="token builtin">normalize</span><span class="token punctuation">(</span>normal_matrix <span class="token operator">*</span> model<span class="token punctuation">.</span>tangent<span class="token punctuation">)</span><span class="token punctuation">;</span>
    out<span class="token punctuation">.</span>world_bitangent <span class="token operator">=</span> <span class="token builtin">normalize</span><span class="token punctuation">(</span>normal_matrix <span class="token operator">*</span> model<span class="token punctuation">.</span>bitangent<span class="token punctuation">)</span><span class="token punctuation">;</span>
    out<span class="token punctuation">.</span>world_position <span class="token operator">=</span> world_position<span class="token punctuation">.</span>xyz<span class="token punctuation">;</span>
    out<span class="token punctuation">.</span>world_view_position <span class="token operator">=</span> camera<span class="token punctuation">.</span>view_pos<span class="token punctuation">.</span>xyz<span class="token punctuation">;</span>
    <span class="token keyword">return</span> out<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// Fragment shader</span>

<span class="token punctuation">@</span><span class="token attributes attr-name">group</span><span class="token punctuation">(</span><span class="token int-literal number">0</span><span class="token punctuation">)</span> <span class="token punctuation">@</span><span class="token attributes attr-name">binding</span><span class="token punctuation">(</span><span class="token int-literal number">0</span><span class="token punctuation">)</span>
<span class="token keyword">var</span> t_diffuse<span class="token punctuation">:</span> <span class="token builtin">texture_2d</span><span class="token punctuation">&lt;</span><span class="token builtin">f32</span><span class="token punctuation">&gt;</span><span class="token punctuation">;</span>
<span class="token punctuation">@</span><span class="token attributes attr-name">group</span><span class="token punctuation">(</span><span class="token int-literal number">0</span><span class="token punctuation">)</span><span class="token punctuation">@</span><span class="token attributes attr-name">binding</span><span class="token punctuation">(</span><span class="token int-literal number">1</span><span class="token punctuation">)</span>
<span class="token keyword">var</span> s_diffuse<span class="token punctuation">:</span> <span class="token builtin">sampler</span><span class="token punctuation">;</span>
<span class="token punctuation">@</span><span class="token attributes attr-name">group</span><span class="token punctuation">(</span><span class="token int-literal number">0</span><span class="token punctuation">)</span><span class="token punctuation">@</span><span class="token attributes attr-name">binding</span><span class="token punctuation">(</span><span class="token int-literal number">2</span><span class="token punctuation">)</span>
<span class="token keyword">var</span> t_normal<span class="token punctuation">:</span> <span class="token builtin">texture_2d</span><span class="token punctuation">&lt;</span><span class="token builtin">f32</span><span class="token punctuation">&gt;</span><span class="token punctuation">;</span>
<span class="token punctuation">@</span><span class="token attributes attr-name">group</span><span class="token punctuation">(</span><span class="token int-literal number">0</span><span class="token punctuation">)</span> <span class="token punctuation">@</span><span class="token attributes attr-name">binding</span><span class="token punctuation">(</span><span class="token int-literal number">3</span><span class="token punctuation">)</span>
<span class="token keyword">var</span> s_normal<span class="token punctuation">:</span> <span class="token builtin">sampler</span><span class="token punctuation">;</span>

<span class="token punctuation">@</span><span class="token attributes attr-name">group</span><span class="token punctuation">(</span><span class="token int-literal number">3</span><span class="token punctuation">)</span>
<span class="token punctuation">@</span><span class="token attributes attr-name">binding</span><span class="token punctuation">(</span><span class="token int-literal number">0</span><span class="token punctuation">)</span>
<span class="token keyword">var</span> env_map<span class="token punctuation">:</span> <span class="token builtin">texture_cube</span><span class="token punctuation">&lt;</span><span class="token builtin">f32</span><span class="token punctuation">&gt;</span><span class="token punctuation">;</span>
<span class="token punctuation">@</span><span class="token attributes attr-name">group</span><span class="token punctuation">(</span><span class="token int-literal number">3</span><span class="token punctuation">)</span>
<span class="token punctuation">@</span><span class="token attributes attr-name">binding</span><span class="token punctuation">(</span><span class="token int-literal number">1</span><span class="token punctuation">)</span>
<span class="token keyword">var</span> env_sampler<span class="token punctuation">:</span> <span class="token builtin">sampler</span><span class="token punctuation">;</span>

<span class="token punctuation">@</span><span class="token attributes attr-name">fragment</span>
<span class="token keyword">fn</span> <span class="token functions function">fs_main</span><span class="token punctuation">(</span>in<span class="token punctuation">:</span> <span class="token class-name">VertexOutput</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">@</span><span class="token attributes attr-name">location</span><span class="token punctuation">(</span><span class="token int-literal number">0</span><span class="token punctuation">)</span> <span class="token builtin">vec4</span><span class="token punctuation">&lt;</span><span class="token builtin">f32</span><span class="token punctuation">&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> object_color<span class="token punctuation">:</span> <span class="token builtin">vec4</span><span class="token punctuation">&lt;</span><span class="token builtin">f32</span><span class="token punctuation">&gt;</span> <span class="token operator">=</span> <span class="token builtin">textureSample</span><span class="token punctuation">(</span>t_diffuse<span class="token punctuation">,</span> s_diffuse<span class="token punctuation">,</span> in<span class="token punctuation">.</span>tex_coords<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> object_normal<span class="token punctuation">:</span> <span class="token builtin">vec4</span><span class="token punctuation">&lt;</span><span class="token builtin">f32</span><span class="token punctuation">&gt;</span> <span class="token operator">=</span> <span class="token builtin">textureSample</span><span class="token punctuation">(</span>t_normal<span class="token punctuation">,</span> s_normal<span class="token punctuation">,</span> in<span class="token punctuation">.</span>tex_coords<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// NEW!</span>
    <span class="token comment">// 그람-슈미트 직교화 과정을 사용하여 탄젠트와 바이탄젠트를 조정합니다.</span>
    <span class="token comment">// 이것은 이들이 서로 수직이고 표면의 노멀과도 수직임을 보장합니다.</span>
    <span class="token keyword">let</span> world_tangent <span class="token operator">=</span> <span class="token builtin">normalize</span><span class="token punctuation">(</span>in<span class="token punctuation">.</span>world_tangent <span class="token operator">-</span> <span class="token builtin">dot</span><span class="token punctuation">(</span>in<span class="token punctuation">.</span>world_tangent<span class="token punctuation">,</span> in<span class="token punctuation">.</span>world_normal<span class="token punctuation">)</span> <span class="token operator">*</span> in<span class="token punctuation">.</span>world_normal<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> world_bitangent <span class="token operator">=</span> <span class="token builtin">cross</span><span class="token punctuation">(</span>world_tangent<span class="token punctuation">,</span> in<span class="token punctuation">.</span>world_normal<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 노멀 샘플을 월드 공간으로 변환합니다.</span>
    <span class="token keyword">let</span> <span class="token class-name">TBN</span> <span class="token operator">=</span> <span class="token builtin">mat3x3</span><span class="token punctuation">(</span>
        world_tangent<span class="token punctuation">,</span>
        world_bitangent<span class="token punctuation">,</span>
        in<span class="token punctuation">.</span>world_normal<span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> tangent_normal <span class="token operator">=</span> object_normal<span class="token punctuation">.</span>xyz <span class="token operator">*</span> <span class="token decimal-float-literal number">2.0</span> <span class="token operator">-</span> <span class="token decimal-float-literal number">1.0</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> world_normal <span class="token operator">=</span> <span class="token class-name">TBN</span> <span class="token operator">*</span> tangent_normal<span class="token punctuation">;</span>

    <span class="token comment">// 조명 벡터를 생성합니다.</span>
    <span class="token keyword">let</span> light_dir <span class="token operator">=</span> <span class="token builtin">normalize</span><span class="token punctuation">(</span>light<span class="token punctuation">.</span>position <span class="token operator">-</span> in<span class="token punctuation">.</span>world_position<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> view_dir <span class="token operator">=</span> <span class="token builtin">normalize</span><span class="token punctuation">(</span>in<span class="token punctuation">.</span>world_view_position <span class="token operator">-</span> in<span class="token punctuation">.</span>world_position<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> half_dir <span class="token operator">=</span> <span class="token builtin">normalize</span><span class="token punctuation">(</span>view_dir <span class="token operator">+</span> light_dir<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> diffuse_strength <span class="token operator">=</span> <span class="token builtin">max</span><span class="token punctuation">(</span><span class="token builtin">dot</span><span class="token punctuation">(</span>world_normal<span class="token punctuation">,</span> light_dir<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token decimal-float-literal number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> diffuse_color <span class="token operator">=</span> light<span class="token punctuation">.</span>color <span class="token operator">*</span> diffuse_strength<span class="token punctuation">;</span>

    <span class="token keyword">let</span> specular_strength <span class="token operator">=</span> <span class="token builtin">pow</span><span class="token punctuation">(</span><span class="token builtin">max</span><span class="token punctuation">(</span><span class="token builtin">dot</span><span class="token punctuation">(</span>world_normal<span class="token punctuation">,</span> half_dir<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token decimal-float-literal number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token decimal-float-literal number">32.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> specular_color <span class="token operator">=</span> specular_strength <span class="token operator">*</span> light<span class="token punctuation">.</span>color<span class="token punctuation">;</span>

    <span class="token comment">// NEW!</span>
    <span class="token comment">// 반사 계산</span>
    <span class="token keyword">let</span> world_reflect <span class="token operator">=</span> <span class="token builtin">reflect</span><span class="token punctuation">(</span><span class="token operator">-</span>view_dir<span class="token punctuation">,</span> world_normal<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> reflection <span class="token operator">=</span> <span class="token builtin">textureSample</span><span class="token punctuation">(</span>env_map<span class="token punctuation">,</span> env_sampler<span class="token punctuation">,</span> world_reflect<span class="token punctuation">)</span><span class="token punctuation">.</span>rgb<span class="token punctuation">;</span>
    <span class="token keyword">let</span> shininess <span class="token operator">=</span> <span class="token decimal-float-literal number">0.1</span><span class="token punctuation">;</span>

    <span class="token keyword">let</span> result <span class="token operator">=</span> <span class="token punctuation">(</span>diffuse_color <span class="token operator">+</span> specular_color<span class="token punctuation">)</span> <span class="token operator">*</span> object_color<span class="token punctuation">.</span>xyz <span class="token operator">+</span> reflection <span class="token operator">*</span> shininess<span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token builtin">vec4</span><span class="token punctuation">&lt;</span><span class="token builtin">f32</span><span class="token punctuation">&gt;</span><span class="token punctuation">(</span>result<span class="token punctuation">,</span> object_color<span class="token punctuation">.</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>반사 수학에 대한 약간의 참고 사항입니다. <code>view_dir</code>는 표면에서 카메라로의 방향을 제공합니다. 반사 수학은 카메라에서 표면으로의 방향이 필요하므로 <code>view_dir</code>를 부정합니다. 그런 다음 <code>wgsl</code>의 내장 <code>reflect</code> 함수를 사용하여 반전된 <code>view_dir</code>를 <code>world_normal</code>에 대해 반사시킵니다. 이것은 환경 맵을 샘플링하고 해당 방향의 하늘 색상을 얻는 데 사용할 수 있는 방향을 제공합니다. 반사 구성 요소만 보면 다음과 같습니다:</p> <p><img src="/learn-wgpu/assets/img/just-reflections.e704b658.png" alt="just-reflections"></p> <p>완성된 씬입니다:</p> <p><img src="/learn-wgpu/assets/img/with-reflections.6bbd4b38.png" alt="with-reflections"></p> <h2 id="webgpu에서-출력이-너무-어두운가요"><a href="#webgpu에서-출력이-너무-어두운가요" class="header-anchor">#</a> WebGPU에서 출력이 너무 어두운가요?</h2> <p>WebGPU는 서피스(surface)의 출력으로 sRGB 텍스처 포맷을 사용하는 것을 지원하지 않습니다. 렌더링에 사용되는 텍스처 뷰가 포맷의 sRGB 버전을 사용하도록 하여 이 문제를 해결할 수 있습니다. 이를 위해 sRGB를 사용하는 뷰 포맷을 허용하도록 서피스 구성을 변경해야 합니다.</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">let</span> config <span class="token operator">=</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">SurfaceConfiguration</span> <span class="token punctuation">{</span>
    usage<span class="token punctuation">:</span> <span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">TextureUsages</span><span class="token punctuation">::</span><span class="token constant">RENDER_ATTACHMENT</span><span class="token punctuation">,</span>
    format<span class="token punctuation">:</span> surface_format<span class="token punctuation">,</span>
    width<span class="token punctuation">:</span> size<span class="token punctuation">.</span>width<span class="token punctuation">,</span>
    height<span class="token punctuation">:</span> size<span class="token punctuation">.</span>height<span class="token punctuation">,</span>
    present_mode<span class="token punctuation">:</span> surface_caps<span class="token punctuation">.</span>present_modes<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    alpha_mode<span class="token punctuation">:</span> surface_caps<span class="token punctuation">.</span>alpha_modes<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token comment">// NEW!</span>
    view_formats<span class="token punctuation">:</span> <span class="token macro property">vec!</span><span class="token punctuation">[</span>surface_format<span class="token punctuation">.</span><span class="token function">add_srgb_suffix</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    desired_maximum_frame_latency<span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>그런 다음 <code>State::render()</code>에서 sRGB가 활성화된 뷰를 생성해야 합니다.</p> <div class="language-rust extra-class"><pre class="language-rust"><code><span class="token keyword">let</span> view <span class="token operator">=</span> output
    <span class="token punctuation">.</span>texture
    <span class="token punctuation">.</span><span class="token function">create_view</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token namespace">wgpu<span class="token punctuation">::</span></span><span class="token class-name">TextureViewDescriptor</span> <span class="token punctuation">{</span>
        format<span class="token punctuation">:</span> <span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">.</span>config<span class="token punctuation">.</span>format<span class="token punctuation">.</span><span class="token function">add_srgb_suffix</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">..</span><span class="token class-name">Default</span><span class="token punctuation">::</span><span class="token function">default</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>또한 <code>HdrPipeline::new()</code>에서 렌더 파이프라인을 생성할 때 <code>config.format.add_srgb_suffix()</code>를 사용하는 것을 눈치챘을 것입니다. sRGB가 활성화된 <code>TextureView</code>가 렌더 파이프라인과 작동하지 않으므로 이것이 필요합니다.</p> <p>이렇게 하면 sRGB 출력을 예상대로 얻을 수 있습니다.</p> <h2 id="데모"><a href="#데모" class="header-anchor">#</a> 데모</h2> <div class="warn"><p>브라우저가 WebGPU를 지원하지 않으면 이 예제는 작동하지 않습니다.</p></div> <div id="wasm-example"><canvas id="canvas"></canvas> <!----> <button>Click to start Tutorial13_hdr!</button></div> <div class="auto-github-link"><a href="https://github.com/sotrh/learn-wgpu/tree/master/code/intermediate/tutorial13-hdr/" target="_blank" rel="noopener noreferrer">Check out the code!</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated: </span> <span class="time">6/11/2025, 8:57:07 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/learn-wgpu/intermediate/tutorial12-camera/" class="prev">
          더 나은 카메라
        </a></span> <span class="next"><a href="/learn-wgpu/showcase/">
          들어가며
        </a>
        →
      </span></p></div> </main></div></div><div class="global-ui"><!----></div></div>
    <script src="/learn-wgpu/assets/js/app.796ffba2.js" defer></script><script src="/learn-wgpu/assets/js/3.d666109b.js" defer></script><script src="/learn-wgpu/assets/js/2.3bb15672.js" defer></script><script src="/learn-wgpu/assets/js/14.1b3a90b7.js" defer></script><script src="/learn-wgpu/assets/js/20.178554f0.js" defer></script><script src="/learn-wgpu/assets/js/37.a2b9f953.js" defer></script>
  </body>
</html>
